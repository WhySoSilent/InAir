/*! WANG-2014@SuZhou 2014-05-29 */
function getRequest(){var a=/\/scenes\/(\w+)/,b=/\/iframe\/(\w+)/;if(a.test(document.URL)||b.test(document.URL)){var c=RegExp.$1;return c}}function getRequest(){var a=/\/scenes\/(\w+)/,b=/\/iframe\/(\w+)/;if(a.test(document.URL)||b.test(document.URL)){var c=RegExp.$1;return c}}Sim={version:1,messages:{}},Sim.Publisher=function(){},Sim.Publisher.prototype.subscribe=function(a,b,c){var d=Sim.messages[a];if(d){if(-1!=this.findSubscriber(d,b))return}else d=[],Sim.messages[a]=d;d.push({subscriber:b,callback:c})},Sim.Publisher.prototype.unsubscribe=function(a,b){if(b){var c=Sim.messages[a];if(c){var d=this.findSubscriber(c,b);-1!=d&&Sim.messages[a].splice(d,1)}}else delete Sim.messages[a]},Sim.Publisher.prototype.publish=function(a){var b=Sim.messages[a];if(b)for(var c=0;c<b.length;c++){for(var d=[],e=0;e<arguments.length-1;e++)d.push(arguments[e+1]);b[c].callback.apply(b[c].subscriber,d)}},Sim.Publisher.prototype.findSubscriber=function(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return c;return-1},Sim.App=function(){Sim.Publisher.call(this),this.renderer=null,this.scene=null,this.camera=null,this.objects=[]},Sim.App.prototype=new Sim.Publisher,Sim.App.prototype.init=function(a){a=a||{};var b=a.container,c=(a.canvas,new THREE.WebGLRenderer({antialias:!0,alpha:!0}));c.setSize(window.innerWidth,window.innerHeight),b.appendChild(c.domElement),c.setClearColorHex(0,0);var d=new THREE.Scene;d.data=this;var e=new THREE.Object3D;e.name="root",d.add(e),this.container=b,this.renderer=c,this.scene=d,this.root=e,this.addDomHandlers()},Sim.App.prototype.run=function(){this.update(),this.renderer.render(this.scene,this.camera);var a=this;requestAnimationFrame(function(){a.run()})},Sim.App.prototype.update=function(){var a,b;for(b=this.objects.length,a=0;b>a;a++)this.objects[a].update()},Sim.App.prototype.addObject=function(a){this.objects.push(a),a.object3D&&this.root.add(a.object3D)},Sim.App.prototype.removeObject=function(a){var b=this.objects.indexOf(a);-1!=b&&(this.objects.splice(b,1),a.object3D&&this.root.remove(a.object3D))},Sim.App.prototype.initMouse=function(){var a=this.renderer.domElement,b=this;a.addEventListener("mousemove",function(a){b.onDocumentMouseMove(a)},!1),a.addEventListener("mousedown",function(a){b.onDocumentMouseDown(a)},!1),a.addEventListener("mouseup",function(a){b.onDocumentMouseUp(a)},!1),$(a).mousewheel(function(a,c){b.onDocumentMouseScroll(a,c)}),this.overObject=null,this.clickedObject=null},Sim.App.prototype.initKeyboard=function(){var a=this.renderer.domElement,b=this;a.addEventListener("keydown",function(a){b.onKeyDown(a)},!1),a.addEventListener("keyup",function(a){b.onKeyUp(a)},!1),a.addEventListener("keypress",function(a){b.onKeyPress(a)},!1),a.setAttribute("tabindex",1),a.style.outline="none"},Sim.App.prototype.addDomHandlers=function(){var a=this;window.addEventListener("resize",function(b){a.onWindowResize(b)},!1)},Sim.App.prototype.onDocumentMouseMove=function(a){if(a.preventDefault(),this.clickedObject&&this.clickedObject.handleMouseMove){var b=null,c=null,d=this.objectFromMouse(a.pageX,a.pageY);d.object==this.clickedObject&&(b=d.point,c=d.normal),this.clickedObject.handleMouseMove(a.pageX,a.pageY,b,c)}else{var e=!1,f=this.overObject,d=this.objectFromMouse(a.pageX,a.pageY);this.overObject=d.object,this.overObject!=f&&(f&&(this.container.style.cursor="auto",f.handleMouseOut&&f.handleMouseOut(a.pageX,a.pageY)),this.overObject&&(this.overObject.overCursor&&(this.container.style.cursor=this.overObject.overCursor),this.overObject.handleMouseOver&&this.overObject.handleMouseOver(a.pageX,a.pageY)),e=!0),!e&&this.handleMouseMove&&this.handleMouseMove(a.pageX,a.pageY)}},Sim.App.prototype.onDocumentMouseDown=function(a){a.preventDefault();var b=!1,c=this.objectFromMouse(a.pageX,a.pageY);c.object&&c.object.handleMouseDown&&(c.object.handleMouseDown(a.pageX,a.pageY,c.point,c.normal),this.clickedObject=c.object,b=!0),!b&&this.handleMouseDown&&this.handleMouseDown(a.pageX,a.pageY)},Sim.App.prototype.onDocumentMouseUp=function(a){a.preventDefault();var b=!1,c=this.objectFromMouse(a.pageX,a.pageY);c.object&&c.object.handleMouseUp&&(c.object.handleMouseUp(a.pageX,a.pageY,c.point,c.normal),b=!0),!b&&this.handleMouseUp&&this.handleMouseUp(a.pageX,a.pageY),this.clickedObject=null},Sim.App.prototype.onDocumentMouseScroll=function(a,b){a.preventDefault(),this.handleMouseScroll&&this.handleMouseScroll(b)},Sim.App.prototype.objectFromMouse=function(a,b){var c=$(this.renderer.domElement).offset(),d=a-c.left,e=b-c.top,f=d/this.container.offsetWidth*2-1,g=2*-(e/this.container.offsetHeight)+1,h=new THREE.Vector3(f,g,.5);this.projector.unprojectVector(h,this.camera);var i=new THREE.Ray(this.camera.position,h.subSelf(this.camera.position).normalize()),j=i.intersecScene(this.scene);if(j.length>0){for(var k=0;!j[k].object.visible;)k++;{var l=j[k],m=(new THREE.Matrix4).getInverse(l.object.matrixWorld);m.multiplyVector3(l.point)}return this.findObjectFromIntersected(l.object,l.point,l.face.normal)}return{object:null,point:null,normal:null}},Sim.App.prototype.findObjectFromIntersected=function(a,b,c){return a.data?{object:a.data,point:b,normal:c}:a.parent?this.findObjectFromIntersected(a.parent,b,c):{object:null,point:null,normal:null}},Sim.App.prototype.onKeyDown=function(a){a.preventDefault(),this.handleKeyDown&&this.handleKeyDown(a.keyCode,a.charCode)},Sim.App.prototype.onKeyUp=function(a){a.preventDefault(),this.handleKeyUp&&this.handleKeyUp(a.keyCode,a.charCode)},Sim.App.prototype.onKeyPress=function(a){a.preventDefault(),this.handleKeyPress&&this.handleKeyPress(a.keyCode,a.charCode)},Sim.App.prototype.onWindowResize=function(){console.log("Resize Render : "+this.container.offsetWidth+"/"+this.container.offsetHeight),this.renderer.setSize(this.container.offsetWidth,this.container.offsetHeight),this.camera.aspect=this.container.offsetWidth/this.container.offsetHeight,this.camera.updateProjectionMatrix()},Sim.App.prototype.focus=function(){this.renderer&&this.renderer.domElement&&this.renderer.domElement.focus()},Sim.Object=function(){Sim.Publisher.call(this),this.object3D=null,this.children=[]},Sim.Object.prototype=new Sim.Publisher,Sim.Object.prototype.init=function(){},Sim.Object.prototype.update=function(){this.updateChildren()},Sim.Object.prototype.setPosition=function(a,b,c){this.object3D&&this.object3D.position.set(a,b,c)},Sim.Object.prototype.setScale=function(a,b,c){this.object3D&&this.object3D.scale.set(a,b,c)},Sim.Object.prototype.setVisible=function(a){function b(a,c){a.visible=c;var d,e=a.children.length;for(d=0;e>d;d++)b(a.children[d],c)}this.object3D&&b(this.object3D,a)},Sim.Object.prototype.update=function(){var a,b;for(b=this.children.length,a=0;b>a;a++)this.children[a].update()},Sim.Object.prototype.setObject3D=function(a){a.data=this,this.object3D=a},Sim.Object.prototype.addChild=function(a){this.children.push(a),a.object3D&&this.object3D.add(a.object3D)},Sim.Object.prototype.removeChild=function(a){var b=this.children.indexOf(a);-1!=b&&(this.children.splice(b,1),a.object3D&&this.object3D.remove(a.object3D))},Sim.Object.prototype.getScene=function(){var a=null;if(this.object3D){for(var b=this.object3D;b.parent;)b=b.parent;a=b}return a},Sim.Object.prototype.getApp=function(){var a=this.getScene();return a?a.data:null},Sim.KeyCodes={},Sim.KeyCodes.KEY_LEFT=37,Sim.KeyCodes.KEY_UP=38,Sim.KeyCodes.KEY_RIGHT=39,Sim.KeyCodes.KEY_DOWN=40,Loader=function(a){THREE.Loader.call(this,a),this.withCredentials=!1},Loader.prototype=Object.create(THREE.Loader.prototype),Loader.prototype.load=function(a,b,c,d){c=c&&"string"==typeof c?c:this.extractUrlBase(a),this.onLoadStart(),this.loadAjaxJSON(this,a,b,c,d)},Loader.prototype.loadAjaxJSON=function(a,b,c,d,e){var f=new XMLHttpRequest,g=0;f.onreadystatechange=function(){if(f.readyState===f.DONE)if(200===f.status||0===f.status){if(f.responseText){var h=JSON.parse(f.responseText);if(Plane.model.metadata=h.metadata,Plane.model.metaMaterial=h.materials,void 0===h.buffers||""===h.buffers){var i=THREE.JSONLoader.prototype.parse(h,d);c(i.geometry,i.materials,h.metadata,h.materials)}else THREE.BinaryLoader.prototype.loadAjaxBuffers(h,c,binaryPath=d,d,e)}else console.warn("THREE.JSONLoader: ["+b+"] seems to be unreachable or file there is empty");a.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+b+"] ["+f.status+"]");else f.readyState===f.LOADING?e&&(0===g&&(g=f.getResponseHeader("Content-Length")),e({total:g,loaded:f.responseText.length})):f.readyState===f.HEADERS_RECEIVED&&void 0!==e&&(g=f.getResponseHeader("Content-Length"))},f.open("GET",b,!0),f.withCredentials=this.withCredentials,f.send(null)},JSONModel=function(){Sim.Object.call(this),this.mesh=null,this.materials=null,this.loaded=!1},JSONModel.prototype=new Sim.Object,JSONModel.prototype.init=function(){Sim.Object.prototype.init.call(this);var a="/data/models/"+Plane.modelId+"/model.js",b=new THREE.Object3D;b.name="model",this.setObject3D(b);CBS.loadStart(),this.load(a)},JSONModel.prototype.load=function(a,b){var c=this,b=b||"auto";if("auto"===b){var d=new Loader;d.load(a,function(a,b,d,e){c.handleLoaded(a,b,d,e)},null,CBS.loadProcess)}if("ascii"===b){var d=new THREE.JSONLoader;d.load(a,function(a,b,d,e){c.handleLoaded(a,b,d,e)},null,CBS.loadProcess)}if("binary"===b){var d=new THREE.BinaryLoader;d.load(a,function(a,b,d,e){c.handleLoaded(a,b,d,e)},null,null,CBS.loadProcess)}if("scene"===b){var d=new THREE.SceneLoader;d.load(a,function(a){console.log(a),c.object3D.add(a.scene),CBS.loadLoaded()})}},JSONModel.prototype.handleLoaded=function(a,b,c,d){Plane.model.metadata=c,Plane.model.metaMaterial=d;var e=new THREE.MeshFaceMaterial(b);if(a.animation)var f=new THREE.SkinnedMesh(a,e);else var f=new THREE.Mesh(a,e);f.castShadow=!0,f.receiveShadow=!0,this.object3D.add(f),this.mesh=f,this.geometry=a,this.materials=b,Plane.materials=b,Plane.geometry=a,this.loaded=!0,Plane.confMaterial?this.config():this.subscribe("confLoaded",this,this.config),CBS.loadLoaded(),this.publish("loaded")},JSONModel.prototype.handleSceneLoaded=function(a){console.log(a),this.object3D.add(a)},JSONModel.prototype.config=function(){function a(a){var b={};a.map&&(b.originalMap=a.map.sourceFile),a.specularMap&&(b.originalSpecularMap=a.specularMap.sourceFile),a.bumpMap&&(b.originalBumpMap=a.bumpMap.sourceFile),a.normalMap&&(b.originalNormalMap=a.normalMap.sourceFile),a.lightMap&&(b.originalLightMap=a.lightMap.sourceFile),a.data=b}for(var b=Plane.confMaterial,c=this.materials,d=0;d<c.length;d++)a(c[d]);if(0!==Plane.confMaterial.length)for(var d=0;d<b.length;d++)b[d]&&this.editMaterial(b[d],c[d])},JSONModel.prototype.editMaterial=function(a,b){function c(a,b){if("map"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("specularMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("bumpMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("normalMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("lightMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("envMap"===a){if(null===b)return null;var c="/data/models/"+Plane.modelId+"/env/"+b,d=[c+"_px.jpg",c+"_nx.jpg",c+"_py.jpg",c+"_ny.jpg",c+"_pz.jpg",c+"_nz.jpg"];return THREE.ImageUtils.loadTextureCube(d)}}if(!Hps.isObjEmpty(a)&&void 0!==b){var d=Hps.mtype(b);if(a.shading&&a.shading!==d){var e=Plane.materials.indexOf(b),f=Plane.model.metaMaterial[e];f.shading=a.shading;var g=THREE.Loader.prototype.createMaterial(f,"/data/models/"+Plane.modelId+"/");Plane.materials[e]=g,b=g,d=Hps.mtype(b)}void 0!==a.DbgName&&(b.name=a.DbgName),void 0!==a.group&&(b.group=a.group),void 0!==a.visible&&(b.visible=a.visible),void 0!==a.blending&&void 0!==THREE[a.blending]&&b.blending!==THREE[a.blending]&&(b.blending=THREE[a.blending]),void 0!==a.side&&(b.side=THREE[a.side]),void 0!==a.wireframe&&(b.wireframe=a.wireframe),void 0!==a.transparent&&(b.transparent=a.transparent),void 0!==a.transparency&&(b.opacity=a.transparency),a.reflectivity&&(b.reflectivity=a.reflectivity),a.refractionRatio&&(b.refractionRatio=a.refractionRatio),a.specularCoef&&"phong"===d&&(b.shininess=a.specularCoef),a.colorDiffuse&&3===a.colorDiffuse.length&&b.color.fromArray(a.colorDiffuse),a.colorAmbient&&3===a.colorAmbient.length&&"basic"!==d&&b.ambient.fromArray(a.colorAmbient),a.colorSpecular&&3===a.colorSpecular.length&&"phong"===d&&b.specular.fromArray(a.colorSpecular),a.colorEmissive&&3===a.colorEmissive.length&&"basic"!==d&&b.emissive.fromArray(a.colorEmissive),void 0!==a.mapDiffuse&&""!==a.mapDiffuse&&(b.map=c("map",a.mapDiffuse)),void 0!==a.mapSpecular&&""!==a.mapSpecular&&(b.specularMap=c("specularMap",a.mapSpecular)),void 0!==a.mapBump&&""!==a.mapBump&&"phong"===d&&(b.bumpMap=c("bumpMap",a.mapBump)),void 0!==a.mapNormal&&""!==a.mapNormal&&"phong"===d&&(b.normalMap=c("normalMap",a.mapNormal)),void 0!==a.mapLight&&""!==a.mapLight&&(b.lightMap=c("lightMap",a.mapLight)),void 0===a.enableMap||a.enableMap||(b.map=null),void 0===a.enableSpecular||a.enableSpecular||(b.specularMap=null),void 0===a.enableBump||a.enableBump||"phong"!==d||(b.bumpMap=null),void 0===a.enableNormal||a.enableNormal||"phong"!==d||(b.normalMap=null),void 0===a.enableLight||a.enableLight||(b.lightMap=null),void 0!==a.enableEnv&&(b.envMap=a.enableEnv&&void 0!==a.mapEnv?c("envMap",a.mapEnv):null),!a.mapDiffuseRepeat||1===a.mapDiffuseRepeat[0]&&1===a.mapDiffuseRepeat[1]||b.map&&b.map.repeat.fromArray(a.mapDiffuseRepeat),!a.mapSpecularRepeat||1===a.mapSpecularRepeat[0]&&1===a.mapSpecularRepeat[1]||b.specularMap&&b.specularMap.repeat.fromArray(a.mapSpecularRepeat),!a.mapBumpRepeat||1===a.mapBumpRepeat[0]&&1===a.mapBumpRepeat[1]||b.bumpMap&&b.bumpMap.repeat.fromArray(a.mapBumpRepeat),!a.mapNormalRepeat||1===a.mapNormalRepeat[0]&&1===a.mapNormalRepeat[1]||b.normalMap&&b.normalMap.repeat.fromArray(a.mapNormalRepeat),!a.mapLightRepeat||1===a.mapLightRepeat[0]&&1===a.mapLightRepeat[1]||b.lightMap&&b.lightMap.repeat.fromArray(a.mapLightRepeat);var h={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};!a.mapDiffuseWrap||"clamp"===a.mapDiffuseWrap[0]&&"clamp"===a.mapDiffuseWrap[1]||b.map&&(b.map.wrapS=h[a.mapDiffuseWrap[0]],b.map.wrapT=h[a.mapDiffuseWrap[1]]),!a.mapSpecularWrap||"clamp"===a.mapSpecularWrap[0]&&"clamp"===a.mapSpecularWrap[1]||b.specularMap&&(b.specularMap.wrapS=h[a.mapSpecularWrap[0]],b.specularMap.wrapT=h[a.mapSpecularWrap[1]]),!a.mapBumpWrap||"clamp"===a.mapBumpWrap[0]&&"clamp"===a.mapBumpWrap[1]||b.bumpMap&&(b.bumpMap.wrapS=h[a.mapBumpWrap[0]],b.bumpMap.wrapT=h[a.mapBumpWrap[1]]),!a.mapNormalWrap||"clamp"===a.mapNormalWrap[0]&&"clamp"===a.mapNormalWrap[1]||b.normalMap&&(b.normalMap.wrapS=h[a.mapNormalWrap[0]],b.normalMap.wrapT=h[a.mapNormalWrap[1]]),!a.mapLightWrap||"clamp"===a.mapLightWrap[0]&&"clamp"===a.mapLightWrap[1]||b.lightMap&&(b.lightMap.wrapS=h[a.mapLightWrap[0]],b.lightMap.wrapT=h[a.mapLightWrap[1]]),!a.mapDiffuseFilter||"LinearFilter"===a.mapDiffuseFilter[0]&&"LinearMipMapLinearFilter"===a.mapDiffuseFilter[1]||b.map&&(b.map.magFilter=THREE[a.mapDiffuseFilter[0]],b.map.minFilter=THREE[a.mapDiffuseFilter[1]]),!a.mapSpecularFilter||"LinearFilter"===a.mapSpecularFilter[0]&&"LinearMipMapLinearFilter"===a.mapSpecularFilter[1]||b.specularMap&&(b.specularMap.magFilter=THREE[a.mapSpecularFilter[0]],b.specularMap.minFilter=THREE[a.mapSpecularFilter[1]]),!a.mapBumpFilter||"LinearFilter"===a.mapBumpFilter[0]&&"LinearMipMapLinearFilter"===a.mapBumpFilter[1]||b.bumpMap&&(b.bumpMap.magFilter=THREE[a.mapBumpFilter[0]],b.bumpMap.minFilter=THREE[a.mapBumpFilter[1]]),!a.mapNormalFilter||"LinearFilter"===a.mapNormalFilter[0]&&"LinearMipMapLinearFilter"===a.mapNormalFilter[1]||b.normalMap&&(b.normalMap.magFilter=THREE[a.mapNormalFilter[0]],b.normalMap.minFilter=THREE[a.mapNormalFilter[1]]),!a.mapLightFilter||"LinearFilter"===a.mapLightFilter[0]&&"LinearMipMapLinearFilter"===a.mapLightFilter[1]||b.lightMap&&(b.lightMap.magFilter=THREE[a.mapLightFilter[0]],b.lightMap.minFilter=THREE[a.mapLightFilter[1]]),b.needsUpdate=!0;var i=Plane.geometry;i.uvsNeedUpdate=!0,i.tangentsNeedUpdate=!0,i.buffersNeedUpdate=!0}},JSONModel.prototype.update=function(){this.loaded},MainCamera=function(){Sim.Object.call(this),this.enable=!0},MainCamera.prototype=new Sim.Object,MainCamera.prototype.init=function(a){Sim.Object.prototype.init.call(this);var b={name:"mainCamera",position:[0,0,2200]},c=new THREE.PerspectiveCamera(45,a.offsetWidth/a.offsetHeight,.1,1e5);return c.name=b.name,c.position.fromArray(b.position),this.camera=c,Plane.confCamera?this.config():this.subscribe("confLoaded",this,this.config),this.setObject3D(c),this},MainCamera.prototype.config=function(){var a=Plane.confCamera;if(!Hps.isObjEmpty(a)){var b=this.camera;a.name&&a.name!==b.name&&(b.name=a.name),a.position&&3===a.position.length&&new TWEEN.Tween(b.position).to({x:a.position[0],y:a.position[1],z:a.position[2]},700).easing(TWEEN.Easing.Sinusoidal.Out).start()}},MainCamera.prototype.handleModelLoaded=function(){},Controls=function(a,b){this.control=null,this.camera=a,this.rendererDom=b,this.ROTATE_SPEED=.5,this.ZOOM_SPEED=1},Controls.prototype=new Sim.Publisher,Controls.prototype.init=function(){var a={type:"OrbitControls",zoom:!0,pan:!0,autoRotate:!0,maxDistance:1e5,minDistance:1,minPolarAngle:0,maxPolarAngle:Math.PI},b=new THREE[a.type](this.camera,this.rendererDom);b.rotateSpeed=this.ROTATE_SPEED,b.zoomSpeed=this.ZOOM_SPEED,b.noZoom=!a.zoom,b.noPan=!a.pan,b.autoRotate=a.autoRotate,b.minDistance=a.minDistance,b.maxDistance=a.maxDistance,b.minPolarAngle=a.minPolarAngle,b.maxPolarAngle=a.maxPolarAngle,this.control=b;var c=this;return this.rendererDom.addEventListener("mousedown",function(){c.onMouseDown.call(c)},!1),this.rendererDom.addEventListener("mousewheel",function(){c.onMouseDown.call(c)},!1),Plane.confControl?this.config():this.subscribe("confLoaded",this,this.config),this.control},Controls.prototype.config=function(){var a=Plane.confControl;if(!Hps.isObjEmpty(a)){var b=this.control;void 0!==a.zoom&&(b.noZoom=!a.zoom),void 0!==a.pan&&(b.noPan=!a.pan),void 0!==a.autoRotate&&(b.autoRotate=a.autoRotate),void 0!==a.minDistance&&a.zoom&&(b.minDistance=a.minDistance),void 0!==a.maxDistance&&a.zoom&&(b.maxDistance=a.maxDistance),void 0!==a.minPolarAngle&&(b.minPolarAngle=a.minPolarAngle),void 0!==a.maxPolarAngle&&(b.maxPolarAngle=a.maxPolarAngle)}},Controls.prototype.onMouseDown=function(){Plane.modelViewer.camera=Plane.modelViewer.userCamera,this.control.autoRotate&&this.delayRotate(),Plane.modelViewer.feature.reTimeout()},Controls.prototype.delayRotate=function(){this.control.autoRotate=!1,this.iiiii&&clearTimeout(this.iiiii);var a=this;this.iiiii=setTimeout(function(){a.control.autoRotate=!0},6e4)},Lighting=function(){Sim.Object.call(this),this.enable=!0},Lighting.prototype=new Sim.Object,Lighting.prototype.init=function(){var a=[{type:"PointLight",name:"主光",color:"#ffffff",intensity:1,distance:0,position:[100,10,100]},{type:"PointLight",name:"辅光",color:"#ffffff",intensity:1,distance:0,position:[-100,10,-100]},{type:"AmbientLight",name:"环境光",color:"#ffffff"},{type:"DirectionalLight",name:"打光",color:"#ffffff",intensity:1,position:[10,100,10]}],b=new THREE.Object3D;return b.name="defaultLights",this.createLights(a,b),Plane.lights=b.children,this.setObject3D(b),Plane.confLight?this.config():this.subscribe("confLoaded",this,this.config),this},Lighting.prototype.config=function(){if(0!==Plane.confLight.length){var a=Plane.confLight,b=this.object3D;b.name="confLights";for(var c=b.children.length;c>0;c--)b.remove(b.children[c-1]);this.createLights(a,b)}},Lighting.prototype.createLights=function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=Hps.style2hex(d.color);if("AmbientLight"===d.type){var f=new THREE[d.type](e);f.name=d.name}if("DirectionalLight"===d.type){var f=new THREE[d.type](e,d.intensity);f.name=d.name,f.position.fromArray(d.position)}if("PointLight"===d.type){var f=new THREE[d.type](e,d.intensity,d.distance);f.name=d.name,f.position.fromArray(d.position)}b.add(f)}},SkyBox=function(a){Sim.Object.call(this),this.containner=a,this.enableOne=null},SkyBox.prototype=new Sim.Object,SkyBox.prototype.init=function(a,b){if(void 0!==a&&""!==a){var b=b||1e4,c="/data/models/"+Plane.modelId+"/env/"+a,d=[c+"_px.jpg",c+"_nx.jpg",c+"_py.jpg",c+"_ny.jpg",c+"_pz.jpg",c+"_nz.jpg"],e=THREE.ImageUtils.loadTextureCube(d),f=THREE.ShaderLib.cube;f.uniforms.tCube.value=e;var g=new THREE.ShaderMaterial({fragmentShader:f.fragmentShader,vertexShader:f.vertexShader,uniforms:f.uniforms,side:THREE.BackSide}),h=new THREE.Mesh(new THREE.CubeGeometry(b,b,b),g);return h.name="skybox",this.remove(),this.containner.add(h),this.enableOne=h,this}},SkyBox.prototype.resize=function(a){this.enableOne&&(this.enableOne.geometry.width=a,this.enableOne.geometry.height=a,this.enableOne.geometry.depth=a,this.enableOne.geometry.buffersNeedUpdate=!0)},SkyBox.prototype.remove=function(){null!==this.enableOne&&(this.containner.remove(this.enableOne),this.enableOne=null)},SkyBox.prototype.enable=function(){if(null!==this.enableOne)this.enableOne.visible=!0;else if("skybox"===Plane.confEnvironment.type&&null!=Plane.confEnvironment.skybox)return void this.init(Plane.confEnvironment.skybox)},SkyBox.prototype.disable=function(){null!==this.enableOne&&(this.enableOne.visible=!1)},Animation=function(){Sim.Object.call(this)},Animation.prototype=new Sim.Object,Animation.prototype.init=function(){for(var a,b,c,d=THREE.AnimationHandler,e=0;b>e;++e){var f=a[e];d.add(f);var g=new THREE.KeyFrameAnimation(f.node,f.name);g.timeScale=1,c.push(g)}},Animation.prototype.toggle=function(){},Config=function(){this.conf=null,this.configed=!1,this.changed=!1,this.cache=[[],[],[]]},Config.prototype=new Sim.Publisher,Config.prototype.init=function(){var a=this,b=new XMLHttpRequest;return b.onreadystatechange=function(){4==b.readyState&&((200==b.status||0==b.status)&&(a.conf=0!==b.responseText.length?JSON.parse(b.responseText):null,a.config()),404==b.status&&(a.conf=null,a.config()))},b.open("GET","/api/models/"+Plane.modelId+"/conf",!0),b.setRequestHeader("Content-Type","application/json;charset=utf8"),b.send(null),Plane.config=this,this.conf22={scene:{},material:[{},{DbgName:"name",shading:"lambert",colorDiffuse:[.3,.3,.9],transparency:0,colorAmbient:[.1,.1,.1],reflectivity:.5,specularCoef:30,visible:!0,mapDiffuse:null,mapBump:null,mapNormal:null,mapSpecular:null,mapEnv:!0},{},{},{},{},{},{},{transparency:.8,reflectivity:1,mapEnv:!0},{},{transparency:0}],light:this.defaultLight(),camera:{name:"oneCamera",position:[1,1,10]},control:this.defaultControl()},this},Config.prototype.config=function(){this.conf?(Plane.confMaterial=this.conf.material||[],Plane.confLight=this.conf.light||this.defaultLight(),Plane.confCamera=this.conf.camera||this.defaultCamera(),Plane.confControl=this.conf.control||this.defaultControl(),Plane.confFeature=this.conf.feature||this.testFeature(),Plane.confBackground=this.conf.background||this.defaultBackground(),Plane.confEnvironment=this.conf.environment||this.defaultEnvironment()):(this.conf={},Plane.confMaterial=[],Plane.confLight=this.defaultLight(),Plane.confCamera=this.defaultCamera(),Plane.confControl=this.defaultControl(),Plane.confFeature=this.testFeature(),Plane.confBackground=this.defaultBackground(),Plane.confEnvironment=this.defaultEnvironment()),this.conf.material=Plane.confMaterial,this.conf.light=Plane.confLight,this.conf.camera=Plane.confCamera,this.conf.control=Plane.confControl,this.conf.feature=Plane.confFeature,this.conf.background=Plane.confBackground,this.conf.environment=Plane.confEnvironment,Plane.conf=this.conf,this.publish("confLoaded"),this.configed=!0,this.publish("configed")},Config.prototype.defaultLight=function(){return[{type:"PointLight",name:"主光(点光)",color:"#ffffff",intensity:1,distance:0,position:[100,10,100]},{type:"PointLight",name:"辅光(点光)",color:"#ffffff",intensity:1,distance:0,position:[-100,10,-100]},{type:"AmbientLight",name:"环境光",color:"#ffffff"},{type:"DirectionalLight",name:"打光(平行光)",color:"#ffffff",intensity:1,position:[10,100,10]}]},Config.prototype.defaultCamera=function(){return{front:1,back:1e3,fog:1,position:[0,0,100],up:[0,1,0],lookAt:[0,0,0]}},Config.prototype.defaultControl=function(){return{type:"OrbitControls",zoom:!0,pan:!0,autoRotate:!0,maxDistance:1e5,minDistance:1,minPolarAngle:0,maxPolarAngle:Math.PI}},Config.prototype.testFeature=function(){return[{title:"Feature one",des:"Describe feature one here...",focus:{position:[[-5.02,11.21,99.24],[-5.02,11.21,30.24]],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]],periodTime:2e3}},{title:"Feature two",des:"Describe feature two here...",focus:{position:[[-1.35,2.89,23.56],[-10.35,3.89,20.56]],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]]}},{title:"Feature three",des:"Describe feature three here...",focus:{position:[[32,32,50],[40,55,21]],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]],periodTime:700}}]},Config.prototype.defaultBackground=function(){return{type:"color",color:"#eeeeee",image:"/data/models/blackberry/background/bg.jpg"}},Config.prototype.defaultEnvironment=function(){return{enable:!1,type:"skybox",skybox:"",size:1e5}},Config.prototype.edit=function(a,b,c){if(void 0!==c?c:!0)this.set(a,b),this.autoSave();else{var d=this.cache[0].indexOf(b);-1===d?(this.cache[0].push(b),this.cache[1].push(a)):this.cache[1][d]=a}},Config.prototype.set=function(a,b){if(void 0!=a){void 0===b&&(b=this.conf);for(var c in a){var d=a[c],e=b[c];void 0!==d&&(d instanceof Object?void 0!==e?!(d instanceof Array)||e instanceof Array?!(d instanceof Array)&&d instanceof Object&&e instanceof Array?(b[c]={},this.set(d,b[c])):this.set(d,b[c]):(b[c]=[],this.set(d,b[c])):(b[c]=d instanceof Array?[]:{},this.set(d,b[c])):(b[c]=d,this.changed=!0))}}},Config.prototype.autoSave=function(a){this.autoSaving&&clearTimeout(this.autoSaving);var b=this;this.autoSaving=setTimeout(function(){b.updateToServer.call(b)},a||5e3)},Config.prototype.updateToServer=function(){if(this.changed){void 0===this.updateStatus&&(this.updateStatus=new UpdateStatus),this.updateStatus.confUpdateStart();var a=this;$.ajax({url:"/api/models/"+Plane.modelId+"/conf",type:"POST",data:JSON.stringify(this.conf),contentType:"application/json",processData:!1,statusCode:{200:function(){a.changed=!1},400:function(){}},success:function(){a.updateStatus.confUpdateSucess()},error:function(){return a.updateStatus.confUpdateError(),void 0===a.reUpdateTimerInterval&&(a.reUpdateTimerInterval=2e3),a.reUpdateTimerInterval>8e3?(alert("遇到问题，所做的修改无法提交..."),void(a.reUpdateTimerInterval=void 0)):void a.autoSave.call(a,a.reUpdateTimerInterval+=1e3)}})}},Config.prototype.emptyFeature=function(){var a=Plane.modelViewer.userCamera.position.toArray(),b=[a[0]+5,a[1]+5,a[2]+10];return{title:"Feature newone",des:"Describe this new feature here...",focus:{position:[a,b],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]],periodTime:2e3}}},Config.prototype.setChanged=function(){this.changed=!0,this.autoSave()},FeatureViewer=function(a,b){this.enable=!0,this.showIndex=0,this.defFrequency=3e3,this.userCamera=b,this.featurePanel=$("#featureLeaver"),this.featureMaodian=$("#featureLeaver .features"),this.template=new EJS({url:"/template/temp_featureView.ejs"}),this.timer=null,this.camera=new THREE.PerspectiveCamera(45,a.offsetWidth/a.offsetHeight,.1,1e5),this.camera.name="FeatureCamera",Plane.confFeature?this.config():this.subscribe("confLoaded",this,this.config)},FeatureViewer.prototype=new Sim.Publisher,FeatureViewer.prototype.ready=function(){var a=this,b=Backbone.Router.extend({routes:{"feature/:id":"focusFeatureOf"},focusFeatureOf:function(b){a.focusThe(b)}});this.router=new b,Backbone.history.start()},FeatureViewer.prototype.focusThe=function(a){var b=Plane.modelViewer.camera;this.camera!==b&&(this.camera.position.copy(b.position),Plane.modelViewer.camera=this.camera),this.playing||this.featurePanel.addClass("display");var c=this.features[a].focus;this.camera.position.fromArray(c.position[0]),new TWEEN.Tween(this.camera.position).to({x:c.position[1][0],y:c.position[1][1],z:c.position[1][2]},c.periodTime||1e3).easing(TWEEN.Easing.Sinusoidal.Out).start(),this.featureMaodian.html(this.template.render(this.features[a])),this.showIndex=a},FeatureViewer.prototype.play=function(){if(!this.playing){this.router.navigate("feature/"+this.showIndex,!0);var a=this;this.timer=setInterval(function(){a.next.call(a)},this.defFrequency),this.playing=!0}},FeatureViewer.prototype.stop=function(){this.playing&&clearInterval(this.timer),this.playing=!1},FeatureViewer.prototype.pre=function(){this.showIndex=(this.showIndex+this.features.length-1)%this.features.length,this.router.navigate("feature/"+this.showIndex,!0)},FeatureViewer.prototype.next=function(){this.showIndex=(this.showIndex+1)%this.features.length,this.router.navigate("feature/"+this.showIndex,!0)},FeatureViewer.prototype.reTimeout=function(){if(this.playing){clearInterval(this.timer);var a=this;this.timer=setInterval(function(){a.next.call(a)},2*this.defFrequency)}},FeatureViewer.prototype.toggle=function(){this.playing?(this.stop(),this.featurePanel.removeClass("display")):(this.play(),this.featurePanel.addClass("display"))},FeatureViewer.prototype.exit=function(){this.stop(),this.router.navigate("",!0)},FeatureViewer.prototype.config=function(){0!==Plane.confFeature.length&&(this.features=Plane.confFeature,this.ready())},Audio=function(){this.audio=null,this.playing=!1},Audio.prototype.init=function(){return this.audio=document.createElement("audio"),this.audio.src="/data/models/"+Plane.modelId+"/audio/audio.mp3",this.audio.play(),this.playing=!0,this},Audio.prototype.play=function(){this.playing||(this.audio.play(),this.playing=!0)},Audio.prototype.stop=function(){this.playing&&(this.audio.pause(),this.playing=!1)},Audio.prototype.toggle=function(){},Plane={modelId:getRequest(),model:{id:getRequest(),name:"",des:"",created:null,metadata:null,metaMaterial:null},geometry:null,materials:null,lights:[],conf:null,confMaterial:null,confLight:null,confCamera:null,confControl:null,confBackground:null,confEnvironment:null,parsedData:null,editer:null,renderStatus:{fps:null,ms:null},config:null},ModelViewer=function(){Sim.App.call(this),this.version=1,this.camera=null,this.control=null,this.environment=null,this.bgAudio=null,this.environmentGroup=new THREE.Object3D,this.SkyBox=new SkyBox(this.environmentGroup)},ModelViewer.prototype=new Sim.App,ModelViewer.prototype.init=function(a){Sim.App.prototype.init.call(this,a),this.subscribe("loaded",this,this.initLoaded),this.environmentGroup.name="environment",this.root.add(this.environmentGroup),this.config=(new Config).init();var b=(new MainCamera).init(a.container);this.addObject(b),this.userCamera=b.object3D,this.camera=b.object3D;var c=new Controls(this.camera,this.renderer.domElement);this.control=c.init();var d=(new Lighting).init();this.addObject(d);var e=new JSONModel;e.init(),this.addObject(e),this.feature=new FeatureViewer(a.container,this.camera),this.featureCamera=this.feature.camera,this.stats=new Stats,this.initOptions(),Plane.conf?this.toConfig():this.subscribe("confLoaded",this,this.toConfig)},ModelViewer.prototype.update=function(){TWEEN.update(),this.control&&this.control.update(),this.stats.update(),Sim.App.prototype.update.call(this)},ModelViewer.prototype.initLoaded=function(){},ModelViewer.prototype.toConfig=function(){var a=Plane.confEnvironment;a&&a.enable&&"skybox"===a.type&&this.SkyBox.init(a.skybox,a.size);var b=Plane.confBackground;b&&($("#WebGLContainer").css({background:b.color}),"image"===b.type&&""!==b.image&&$("#WebGLContainer canvas").css({"background-image":"url("+b.image+")"}))},ModelViewer.prototype.initOptions=function(){var a=function(a){return-1!==a.indexOf("admin")?"admin":-1!==a.indexOf("scene")?"scene":-1!==a.indexOf("iframe")?"iframe":void 0}(document.URL),b=new EJS({url:"/template/temp_sceneOption.ejs"}).render({id:Plane.modelId,type:a});$("#sceneOptionInsert").html(b),$('#canvasOpts a[data-toggle="tooltip"]').tooltip(),$("#saveSnapshot").click(CBS.saveSnapshot()),$("#featurePlay").click(CBS.featurePlay),$("#featureLeaver>a.pre").click(CBS.featurePre),$("#featureLeaver>a.next").click(CBS.featureNext),$("#toggleFullscreen").click(CBS.toggleFullscreen),function(){function a(){b.html(Plane.renderStatus.fps)
}var b=$("#renderStatus");void 0!==b[0]&&setInterval(a,1e3)}()},CBS={loadStart:function(){$("#canvasCover").addClass("display")},loadProcess:function(a){$("div#loadingBar div.loadedWidth").css("width",(a.loaded/a.total*100).toFixed(0)+"%")},loadLoaded:function(){$("#canvasCover").removeClass("display")},setMetas:function(a){if(a.err&&alert("ERROR: "+a),Plane.model.id=a.id,Plane.model.name=a.name,Plane.model.des=a.des,Plane.model.created=new Date(a.created),$("#outerName").html(a.name),$("#outerDes").html(a.des),$("#headlineArea>h1").html(a.name),$("#headlineArea>h3").html(a.des),$("head title").html(a.name+" | Not video, is 3D"),void 0!==$("#shareLinks")[0]){var b=new EJS({url:"/template/temp_shareLinks.ejs"}).render({id:a.id});$("#shareLinks").append(b)}},saveSnapshot:function(){var a=0;return function(){var b=$("#WebGLContainer>canvas")[0],c=b.toDataURL();this.href=c,this.download="snapShot"+(0===a?"":a)+".png",a++}},featurePlay:function(){Plane.modelViewer.feature.toggle()},featurePre:function(){var a=Plane.modelViewer.feature;a.playing&&a.reTimeout(),a.pre()},featureNext:function(){var a=Plane.modelViewer.feature;a.playing&&a.reTimeout(),a.next()},toggleFullscreen:function(){$("#WebGLContainer").toggleClass("fullScreen"),$("#header").toggleClass("hiddenStyle");var a=document.getElementById("WebGLContainer");Plane.modelViewer.renderer.setSize(a.offsetWidth,a.offsetHeight),Plane.modelViewer.camera.aspect=a.offsetWidth/a.offsetHeight,Plane.modelViewer.camera.updateProjectionMatrix(),console.log("CSS Resize Render : "+a.offsetWidth+"/"+a.offsetHeight),CBS.toggleScreen()},fullscreen:function(){var a=document.documentElement;return a.webkitRequestFullScreen?a.webkitRequestFullScreen:a.mozRequestFullScreen?a.mozRequestFullScreen:a.requestFullScreen?a.requestFullscreen:function(){}}(),exitFullscreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozExitFullScreen?document.mozExitFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()},toggleScreen:function(){var a=!0;return function(){a?(CBS.exitFullscreen(),a=!1):(CBS.fullscreen.call(document.documentElement),a=!0)}}()},Hps={array2style:function(a){var b=255*a[0]<<16^255*a[1]<<8^255*a[2]<<0;return"#"+("000000"+b.toString(16)).slice(-6)},style2array:function(a){var b=Math.floor(parseInt(a.slice(1),16)),c=(b>>16&255)/255,d=(b>>8&255)/255,e=(255&b)/255;return[c,d,e]},array2hex:function(a){return 255*a[0]<<16^255*a[1]<<8^255*a[2]<<0},hex2style:function(a){return"#"+("000000"+a.toString(16)).slice(-6)},style2hex:function(a){return Hps.array2hex(Hps.style2array(a))},isObjEmpty:function(a){if(null==a)return!1;for(var b in a)return!1;return!0},mtype:function(a){return a instanceof THREE.MeshBasicMaterial?"basic":a instanceof THREE.MeshLambertMaterial?"lambert":a instanceof THREE.MeshPhongMaterial?"phong":a instanceof THREE.ShaderMaterial?"shader":"material"},ltype:function(a){return a instanceof THREE.AmbientLight?"AmbientLight":a instanceof THREE.PointLight?"PointLight":a instanceof THREE.DirectionalLight?"DirectionalLight":"light"},ctype:function(a){return a instanceof THREE.TrackballControls?"TrackballControls":a instanceof THREE.OrbitControls?"OrbitControls":"controls"},btype:function(a){return 0===a?"NoBlending":1===a?"NormalBlending":2===a?"AdditiveBlending":3===a?"SubtractiveBlending":4===a?"MultiplyBlending":"CustomBlending"}},Previewer=function(){this.previewId=getRequest(),this.files=null,this.previews=[]},Previewer.prototype.init=function(){var a=new EJS({url:"/template/temp_previewer.ejs"}).render({id:this.previewId});$("#WebGLContainer").append(a),this.dom=$("#previewer"),this.imgHandler=this.dom.find("#imgHandler")[0],this.loadImgs(this.previewId)},Previewer.prototype.loadImgs=function(a){var b="/data/models/"+a+"/preview/",c=this;$.ajax({type:"GET",url:b+"preview.list",success:function(a){if(c.files=JSON.parse(a),!(!c.files instanceof Array)){for(var d=0,e=c.files.length;e>d;d++)c.previews[d]=new Image,c.previews[d].src=b+c.files[d];c.imgHandler.src=c.previews[0].src,c.initControl.call(c),$("#previewerApplyTips").css("display","block")}},error:function(){console.log("Oops!...")}})},Previewer.prototype.initControl=function(){function a(a){j=a.clientX,e.addEventListener("mousemove",b,!1),e.addEventListener("mouseup",c,!1)}function b(a){a.preventDefault(),x=a.clientX-j,j=a.clientX,Math.abs(x)<2||(0>x?i=(i+1)%h:0>i-1?i=h-1:i-=1,f.src=g[i].src)}function c(){e.removeEventListener("mousemove",b,!1),e.removeEventListener("mouseup",c,!1)}function d(a){a.preventDefault(),a.stopPropagation();var b=0;a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail),0>b?i=(i+1)%h:0>i-1?i=h-1:i-=1,f.src=g[i].src}var e=this.dom[0],f=this.imgHandler,g=this.previews,h=this.files.length,i=0,j=x=0;e.addEventListener("mousedown",a,!1),e.addEventListener("mousewheel",d,!1)},Previewer.prototype.reflesh=function(){},$(function(){function a(a){if(a instanceof Array){for(var b=0,c=a.length;c>b;b++){var e=new EJS({url:"/template/temp_comment.ejs"}).render(a[b]);$("#commentContainner").append(e)}d(a.length)}else{var e=new EJS({url:"/template/temp_comment.ejs"}).render(a);$("#commentContainner").prepend(e),d()}}function b(){$("#commentInput").val(""),$("#anonymous").val("off"),$("#newComment").removeClass("edit")}function c(a){var b=/^([a-zA-Z0-9]+[_|_|.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|_|.]?)*[a-zA-Z0-9]+.[a-zA-Z]{2,4}$/;return b.test(a)}function d(a){var b=$("#commentCount"),a=Number(b.attr("data-count"))+(void 0===a?1:a);b.attr("data-count",a),b.html(a+" Comments")}$("#commentInput").focus(function(){$("#newComment").addClass("edit")}),$("#anonymous").click(function(){var a=$(this).prop("checked");return a||confirm("Cancel anonymity will make your e-mail address is exposed, still determined to do so?")?void 0:void $(this).prop("checked",!0)}),$.ajax({url:"/api/models/"+Plane.modelId+"/comments",type:"GET",success:function(b){a(b)},error:function(){}}),$("#publishNew").click(function(){var d=$("#mail").val(),e=$("#commentInput").val(),f=$("#anonymous").is(":checked");return""==e?void alert("Enter comment ..."):""==d?void alert("Provide your e-mail address to comment!"):c(d)?void $.ajax({url:"/api/models/"+Plane.modelId+"/comments/create",type:"POST",data:"mail="+d+"&anonymous="+f+"&content="+e,statusCode:{201:function(c){a(c),b()},400:function(){}},error:function(){b()}}):void alert("Please provide the correct e-mail address")})});