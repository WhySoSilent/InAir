/*! WANG-2014@SuZhou 2014-09-01 */
function getRequest(){var a=/\/scenes\/(\w+)/,b=/\/iframe\/(\w+)/;if(a.test(document.URL)||b.test(document.URL)){var c=RegExp.$1;return c}}Sim={version:1,messages:{}},Sim.Publisher=function(){},Sim.Publisher.prototype.subscribe=function(a,b,c){var d=Sim.messages[a];if(d){if(-1!=this.findSubscriber(d,b))return}else d=[],Sim.messages[a]=d;d.push({subscriber:b,callback:c})},Sim.Publisher.prototype.unsubscribe=function(a,b){if(b){var c=Sim.messages[a];if(c){var d=this.findSubscriber(c,b);-1!=d&&Sim.messages[a].splice(d,1)}}else delete Sim.messages[a]},Sim.Publisher.prototype.publish=function(a){var b=Sim.messages[a];if(b)for(var c=0;c<b.length;c++){for(var d=[],e=0;e<arguments.length-1;e++)d.push(arguments[e+1]);b[c].callback.apply(b[c].subscriber,d)}},Sim.Publisher.prototype.findSubscriber=function(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return c;return-1},Sim.App=function(){Sim.Publisher.call(this),this.renderer=null,this.scene=null,this.camera=null,this.objects=[]},Sim.App.prototype=new Sim.Publisher,Sim.App.prototype.init=function(a){a=a||{};var b=a.container,c=(a.canvas,new THREE.WebGLRenderer({antialias:!0,alpha:!0}));c.setSize(window.innerWidth,window.innerHeight),b.appendChild(c.domElement),c.setClearColorHex(0,0);var d=new THREE.Scene;d.data=this;var e=new THREE.Object3D;e.name="root",d.add(e),this.container=b,this.renderer=c,this.scene=d,this.root=e,this.addDomHandlers()},Sim.App.prototype.run=function(){this.update(),this.renderer.render(this.scene,this.camera);var a=this;requestAnimationFrame(function(){a.run()})},Sim.App.prototype.update=function(){var a,b;for(b=this.objects.length,a=0;b>a;a++)this.objects[a].update()},Sim.App.prototype.addObject=function(a){this.objects.push(a),a.object3D&&this.root.add(a.object3D)},Sim.App.prototype.removeObject=function(a){var b=this.objects.indexOf(a);-1!=b&&(this.objects.splice(b,1),a.object3D&&this.root.remove(a.object3D))},Sim.App.prototype.initMouse=function(){var a=this.renderer.domElement,b=this;a.addEventListener("mousemove",function(a){b.onDocumentMouseMove(a)},!1),a.addEventListener("mousedown",function(a){b.onDocumentMouseDown(a)},!1),a.addEventListener("mouseup",function(a){b.onDocumentMouseUp(a)},!1),$(a).mousewheel(function(a,c){b.onDocumentMouseScroll(a,c)}),this.overObject=null,this.clickedObject=null},Sim.App.prototype.initKeyboard=function(){var a=this.renderer.domElement,b=this;a.addEventListener("keydown",function(a){b.onKeyDown(a)},!1),a.addEventListener("keyup",function(a){b.onKeyUp(a)},!1),a.addEventListener("keypress",function(a){b.onKeyPress(a)},!1),a.setAttribute("tabindex",1),a.style.outline="none"},Sim.App.prototype.addDomHandlers=function(){var a=this;window.addEventListener("resize",function(b){a.onWindowResize(b)},!1)},Sim.App.prototype.onDocumentMouseMove=function(a){if(a.preventDefault(),this.clickedObject&&this.clickedObject.handleMouseMove){var b=null,c=null,d=this.objectFromMouse(a.pageX,a.pageY);d.object==this.clickedObject&&(b=d.point,c=d.normal),this.clickedObject.handleMouseMove(a.pageX,a.pageY,b,c)}else{var e=!1,f=this.overObject,d=this.objectFromMouse(a.pageX,a.pageY);this.overObject=d.object,this.overObject!=f&&(f&&(this.container.style.cursor="auto",f.handleMouseOut&&f.handleMouseOut(a.pageX,a.pageY)),this.overObject&&(this.overObject.overCursor&&(this.container.style.cursor=this.overObject.overCursor),this.overObject.handleMouseOver&&this.overObject.handleMouseOver(a.pageX,a.pageY)),e=!0),!e&&this.handleMouseMove&&this.handleMouseMove(a.pageX,a.pageY)}},Sim.App.prototype.onDocumentMouseDown=function(a){a.preventDefault();var b=!1,c=this.objectFromMouse(a.pageX,a.pageY);c.object&&c.object.handleMouseDown&&(c.object.handleMouseDown(a.pageX,a.pageY,c.point,c.normal),this.clickedObject=c.object,b=!0),!b&&this.handleMouseDown&&this.handleMouseDown(a.pageX,a.pageY)},Sim.App.prototype.onDocumentMouseUp=function(a){a.preventDefault();var b=!1,c=this.objectFromMouse(a.pageX,a.pageY);c.object&&c.object.handleMouseUp&&(c.object.handleMouseUp(a.pageX,a.pageY,c.point,c.normal),b=!0),!b&&this.handleMouseUp&&this.handleMouseUp(a.pageX,a.pageY),this.clickedObject=null},Sim.App.prototype.onDocumentMouseScroll=function(a,b){a.preventDefault(),this.handleMouseScroll&&this.handleMouseScroll(b)},Sim.App.prototype.objectFromMouse=function(a,b){var c=$(this.renderer.domElement).offset(),d=a-c.left,e=b-c.top,f=d/this.container.offsetWidth*2-1,g=2*-(e/this.container.offsetHeight)+1,h=new THREE.Vector3(f,g,.5);this.projector.unprojectVector(h,this.camera);var i=new THREE.Ray(this.camera.position,h.subSelf(this.camera.position).normalize()),j=i.intersecScene(this.scene);if(j.length>0){for(var k=0;!j[k].object.visible;)k++;{var l=j[k],m=(new THREE.Matrix4).getInverse(l.object.matrixWorld);m.multiplyVector3(l.point)}return this.findObjectFromIntersected(l.object,l.point,l.face.normal)}return{object:null,point:null,normal:null}},Sim.App.prototype.findObjectFromIntersected=function(a,b,c){return a.data?{object:a.data,point:b,normal:c}:a.parent?this.findObjectFromIntersected(a.parent,b,c):{object:null,point:null,normal:null}},Sim.App.prototype.onKeyDown=function(a){a.preventDefault(),this.handleKeyDown&&this.handleKeyDown(a.keyCode,a.charCode)},Sim.App.prototype.onKeyUp=function(a){a.preventDefault(),this.handleKeyUp&&this.handleKeyUp(a.keyCode,a.charCode)},Sim.App.prototype.onKeyPress=function(a){a.preventDefault(),this.handleKeyPress&&this.handleKeyPress(a.keyCode,a.charCode)},Sim.App.prototype.onWindowResize=function(){console.log("Resize Render : "+this.container.offsetWidth+"/"+this.container.offsetHeight),this.renderer.setSize(this.container.offsetWidth,this.container.offsetHeight),this.camera.aspect=this.container.offsetWidth/this.container.offsetHeight,this.camera.updateProjectionMatrix()},Sim.App.prototype.focus=function(){this.renderer&&this.renderer.domElement&&this.renderer.domElement.focus()},Sim.Object=function(){Sim.Publisher.call(this),this.object3D=null,this.children=[]},Sim.Object.prototype=new Sim.Publisher,Sim.Object.prototype.init=function(){},Sim.Object.prototype.update=function(){this.updateChildren()},Sim.Object.prototype.setPosition=function(a,b,c){this.object3D&&this.object3D.position.set(a,b,c)},Sim.Object.prototype.setScale=function(a,b,c){this.object3D&&this.object3D.scale.set(a,b,c)},Sim.Object.prototype.setVisible=function(a){function b(a,c){a.visible=c;var d,e=a.children.length;for(d=0;e>d;d++)b(a.children[d],c)}this.object3D&&b(this.object3D,a)},Sim.Object.prototype.update=function(){var a,b;for(b=this.children.length,a=0;b>a;a++)this.children[a].update()},Sim.Object.prototype.setObject3D=function(a){a.data=this,this.object3D=a},Sim.Object.prototype.addChild=function(a){this.children.push(a),a.object3D&&this.object3D.add(a.object3D)},Sim.Object.prototype.removeChild=function(a){var b=this.children.indexOf(a);-1!=b&&(this.children.splice(b,1),a.object3D&&this.object3D.remove(a.object3D))},Sim.Object.prototype.getScene=function(){var a=null;if(this.object3D){for(var b=this.object3D;b.parent;)b=b.parent;a=b}return a},Sim.Object.prototype.getApp=function(){var a=this.getScene();return a?a.data:null},Sim.KeyCodes={},Sim.KeyCodes.KEY_LEFT=37,Sim.KeyCodes.KEY_UP=38,Sim.KeyCodes.KEY_RIGHT=39,Sim.KeyCodes.KEY_DOWN=40,Loader=function(a){THREE.Loader.call(this,a),this.withCredentials=!1},Loader.prototype=Object.create(THREE.Loader.prototype),Loader.prototype.load=function(a,b,c,d){c=c&&"string"==typeof c?c:this.extractUrlBase(a),this.onLoadStart(),this.loadAjaxJSON(this,a,b,c,d)},Loader.prototype.loadAjaxJSON=function(a,b,c,d,e){var f=new XMLHttpRequest,g=0;f.onreadystatechange=function(){if(f.readyState===f.DONE)if(200===f.status||0===f.status){if(f.responseText){var h=JSON.parse(f.responseText);if(Plane.model.metadata=h.metadata,Plane.model.metaMaterial=h.materials,void 0===h.buffers||""===h.buffers){var i=THREE.JSONLoader.prototype.parse(h,d);c(i.geometry,i.materials,h.metadata,h.materials)}else THREE.BinaryLoader.prototype.loadAjaxBuffers(h,c,binaryPath=d,d,e)}else console.warn("THREE.JSONLoader: ["+b+"] seems to be unreachable or file there is empty");a.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+b+"] ["+f.status+"]");else f.readyState===f.LOADING?e&&(0===g&&(g=f.getResponseHeader("Content-Length")),e({total:g,loaded:f.responseText.length})):f.readyState===f.HEADERS_RECEIVED&&void 0!==e&&(g=f.getResponseHeader("Content-Length"))},f.open("GET",b,!0),f.withCredentials=this.withCredentials,f.send(null)},JSONModel=function(){Sim.Object.call(this),this.mesh=null,this.materials=null,this.loaded=!1},JSONModel.prototype=new Sim.Object,JSONModel.prototype.init=function(){Sim.Object.prototype.init.call(this);var a="/data/models/"+Plane.modelId+"/model.js",b=new THREE.Object3D;b.name="model",this.setObject3D(b);CBS.loadStart(),this.load(a)},JSONModel.prototype.load=function(a,b){var c=this,b=b||"auto";if("auto"===b){var d=new Loader;d.load(a,function(a,b,d,e){c.handleLoaded(a,b,d,e)},null,CBS.loadProcess)}if("ascii"===b){var d=new THREE.JSONLoader;d.load(a,function(a,b,d,e){c.handleLoaded(a,b,d,e)},null,CBS.loadProcess)}if("binary"===b){var d=new THREE.BinaryLoader;d.load(a,function(a,b,d,e){c.handleLoaded(a,b,d,e)},null,null,CBS.loadProcess)}if("scene"===b){var d=new THREE.SceneLoader;d.load(a,function(a){console.log(a),c.object3D.add(a.scene),CBS.loadLoaded()})}},JSONModel.prototype.handleLoaded=function(a,b,c,d){Plane.model.metadata=c,Plane.model.metaMaterial=d;var e=new THREE.MeshFaceMaterial(b);if(a.animation)var f=new THREE.SkinnedMesh(a,e);else var f=new THREE.Mesh(a,e);f.castShadow=!0,f.receiveShadow=!0,this.object3D.add(f),this.mesh=f,this.geometry=a,this.materials=b,Plane.materials=b,Plane.geometry=a,this.loaded=!0,Plane.confMaterial?this.config():this.subscribe("confLoaded",this,this.config),CBS.loadLoaded(),this.publish("loaded")},JSONModel.prototype.handleSceneLoaded=function(a){console.log(a),this.object3D.add(a)},JSONModel.prototype.config=function(){function a(a){var b={};a.map&&(b.originalMap=a.map.sourceFile),a.specularMap&&(b.originalSpecularMap=a.specularMap.sourceFile),a.bumpMap&&(b.originalBumpMap=a.bumpMap.sourceFile),a.normalMap&&(b.originalNormalMap=a.normalMap.sourceFile),a.lightMap&&(b.originalLightMap=a.lightMap.sourceFile),a.data=b}for(var b=Plane.confMaterial,c=this.materials,d=0;d<c.length;d++)a(c[d]);if(0!==Plane.confMaterial.length)for(var d=0;d<b.length;d++)b[d]&&this.editMaterial(b[d],c[d])},JSONModel.prototype.editMaterial=function(a,b){function c(a,b){if("map"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("specularMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("bumpMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("normalMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("lightMap"===a)return null===b?null:THREE.ImageUtils.loadTexture("/data/models/"+Plane.modelId+"/"+b);if("envMap"===a){if(null===b)return null;var c="/data/models/"+Plane.modelId+"/env/"+b,d=[c+"_px.jpg",c+"_nx.jpg",c+"_py.jpg",c+"_ny.jpg",c+"_pz.jpg",c+"_nz.jpg"];return THREE.ImageUtils.loadTextureCube(d)}}if(!Hps.isObjEmpty(a)&&void 0!==b){var d=Hps.mtype(b);if(a.shading&&a.shading!==d){var e=Plane.materials.indexOf(b),f=Plane.model.metaMaterial[e];f.shading=a.shading;var g=THREE.Loader.prototype.createMaterial(f,"/data/models/"+Plane.modelId+"/");Plane.materials[e]=g,b=g,d=Hps.mtype(b)}void 0!==a.DbgName&&(b.name=a.DbgName),void 0!==a.group&&(b.group=a.group),void 0!==a.visible&&(b.visible=a.visible),void 0!==a.blending&&void 0!==THREE[a.blending]&&b.blending!==THREE[a.blending]&&(b.blending=THREE[a.blending]),void 0!==a.side&&(b.side=THREE[a.side]),void 0!==a.wireframe&&(b.wireframe=a.wireframe),void 0!==a.transparent&&(b.transparent=a.transparent),void 0!==a.transparency&&(b.opacity=a.transparency),a.reflectivity&&(b.reflectivity=a.reflectivity),a.refractionRatio&&(b.refractionRatio=a.refractionRatio),a.specularCoef&&"phong"===d&&(b.shininess=a.specularCoef),a.colorDiffuse&&3===a.colorDiffuse.length&&b.color.fromArray(a.colorDiffuse),a.colorAmbient&&3===a.colorAmbient.length&&"basic"!==d&&b.ambient.fromArray(a.colorAmbient),a.colorSpecular&&3===a.colorSpecular.length&&"phong"===d&&b.specular.fromArray(a.colorSpecular),a.colorEmissive&&3===a.colorEmissive.length&&"basic"!==d&&b.emissive.fromArray(a.colorEmissive),void 0!==a.mapDiffuse&&""!==a.mapDiffuse&&(b.map=c("map",a.mapDiffuse)),void 0!==a.mapSpecular&&""!==a.mapSpecular&&(b.specularMap=c("specularMap",a.mapSpecular)),void 0!==a.mapBump&&""!==a.mapBump&&"phong"===d&&(b.bumpMap=c("bumpMap",a.mapBump)),void 0!==a.mapNormal&&""!==a.mapNormal&&"phong"===d&&(b.normalMap=c("normalMap",a.mapNormal)),void 0!==a.mapLight&&""!==a.mapLight&&(b.lightMap=c("lightMap",a.mapLight)),void 0===a.enableMap||a.enableMap||(b.map=null),void 0===a.enableSpecular||a.enableSpecular||(b.specularMap=null),void 0===a.enableBump||a.enableBump||"phong"!==d||(b.bumpMap=null),void 0===a.enableNormal||a.enableNormal||"phong"!==d||(b.normalMap=null),void 0===a.enableLight||a.enableLight||(b.lightMap=null),void 0!==a.enableEnv&&(b.envMap=a.enableEnv&&void 0!==a.mapEnv?c("envMap",a.mapEnv):null),!a.mapDiffuseRepeat||1===a.mapDiffuseRepeat[0]&&1===a.mapDiffuseRepeat[1]||b.map&&b.map.repeat.fromArray(a.mapDiffuseRepeat),!a.mapSpecularRepeat||1===a.mapSpecularRepeat[0]&&1===a.mapSpecularRepeat[1]||b.specularMap&&b.specularMap.repeat.fromArray(a.mapSpecularRepeat),!a.mapBumpRepeat||1===a.mapBumpRepeat[0]&&1===a.mapBumpRepeat[1]||b.bumpMap&&b.bumpMap.repeat.fromArray(a.mapBumpRepeat),!a.mapNormalRepeat||1===a.mapNormalRepeat[0]&&1===a.mapNormalRepeat[1]||b.normalMap&&b.normalMap.repeat.fromArray(a.mapNormalRepeat),!a.mapLightRepeat||1===a.mapLightRepeat[0]&&1===a.mapLightRepeat[1]||b.lightMap&&b.lightMap.repeat.fromArray(a.mapLightRepeat);var h={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};!a.mapDiffuseWrap||"clamp"===a.mapDiffuseWrap[0]&&"clamp"===a.mapDiffuseWrap[1]||b.map&&(b.map.wrapS=h[a.mapDiffuseWrap[0]],b.map.wrapT=h[a.mapDiffuseWrap[1]]),!a.mapSpecularWrap||"clamp"===a.mapSpecularWrap[0]&&"clamp"===a.mapSpecularWrap[1]||b.specularMap&&(b.specularMap.wrapS=h[a.mapSpecularWrap[0]],b.specularMap.wrapT=h[a.mapSpecularWrap[1]]),!a.mapBumpWrap||"clamp"===a.mapBumpWrap[0]&&"clamp"===a.mapBumpWrap[1]||b.bumpMap&&(b.bumpMap.wrapS=h[a.mapBumpWrap[0]],b.bumpMap.wrapT=h[a.mapBumpWrap[1]]),!a.mapNormalWrap||"clamp"===a.mapNormalWrap[0]&&"clamp"===a.mapNormalWrap[1]||b.normalMap&&(b.normalMap.wrapS=h[a.mapNormalWrap[0]],b.normalMap.wrapT=h[a.mapNormalWrap[1]]),!a.mapLightWrap||"clamp"===a.mapLightWrap[0]&&"clamp"===a.mapLightWrap[1]||b.lightMap&&(b.lightMap.wrapS=h[a.mapLightWrap[0]],b.lightMap.wrapT=h[a.mapLightWrap[1]]),!a.mapDiffuseFilter||"LinearFilter"===a.mapDiffuseFilter[0]&&"LinearMipMapLinearFilter"===a.mapDiffuseFilter[1]||b.map&&(b.map.magFilter=THREE[a.mapDiffuseFilter[0]],b.map.minFilter=THREE[a.mapDiffuseFilter[1]]),!a.mapSpecularFilter||"LinearFilter"===a.mapSpecularFilter[0]&&"LinearMipMapLinearFilter"===a.mapSpecularFilter[1]||b.specularMap&&(b.specularMap.magFilter=THREE[a.mapSpecularFilter[0]],b.specularMap.minFilter=THREE[a.mapSpecularFilter[1]]),!a.mapBumpFilter||"LinearFilter"===a.mapBumpFilter[0]&&"LinearMipMapLinearFilter"===a.mapBumpFilter[1]||b.bumpMap&&(b.bumpMap.magFilter=THREE[a.mapBumpFilter[0]],b.bumpMap.minFilter=THREE[a.mapBumpFilter[1]]),!a.mapNormalFilter||"LinearFilter"===a.mapNormalFilter[0]&&"LinearMipMapLinearFilter"===a.mapNormalFilter[1]||b.normalMap&&(b.normalMap.magFilter=THREE[a.mapNormalFilter[0]],b.normalMap.minFilter=THREE[a.mapNormalFilter[1]]),!a.mapLightFilter||"LinearFilter"===a.mapLightFilter[0]&&"LinearMipMapLinearFilter"===a.mapLightFilter[1]||b.lightMap&&(b.lightMap.magFilter=THREE[a.mapLightFilter[0]],b.lightMap.minFilter=THREE[a.mapLightFilter[1]]),b.needsUpdate=!0;var i=Plane.geometry;i.uvsNeedUpdate=!0,i.tangentsNeedUpdate=!0,i.buffersNeedUpdate=!0}},JSONModel.prototype.update=function(){this.loaded},MainCamera=function(){Sim.Object.call(this),this.enable=!0},MainCamera.prototype=new Sim.Object,MainCamera.prototype.init=function(a){Sim.Object.prototype.init.call(this);var b={name:"mainCamera",position:[0,0,2200]},c=new THREE.PerspectiveCamera(45,a.offsetWidth/a.offsetHeight,.1,1e5);return c.name=b.name,c.position.fromArray(b.position),this.camera=c,Plane.confCamera?this.config():this.subscribe("confLoaded",this,this.config),this.setObject3D(c),this},MainCamera.prototype.config=function(){var a=Plane.confCamera;if(!Hps.isObjEmpty(a)){var b=this.camera;a.name&&a.name!==b.name&&(b.name=a.name),a.position&&3===a.position.length&&new TWEEN.Tween(b.position).to({x:a.position[0],y:a.position[1],z:a.position[2]},700).easing(TWEEN.Easing.Sinusoidal.Out).start()}},MainCamera.prototype.handleModelLoaded=function(){},Controls=function(a,b){this.control=null,this.camera=a,this.rendererDom=b,this.ROTATE_SPEED=.5,this.ZOOM_SPEED=1},Controls.prototype=new Sim.Publisher,Controls.prototype.init=function(){var a={type:"OrbitControls",zoom:!0,pan:!0,autoRotate:!0,maxDistance:1e5,minDistance:1,minPolarAngle:0,maxPolarAngle:Math.PI},b=new THREE[a.type](this.camera,this.rendererDom);b.rotateSpeed=this.ROTATE_SPEED,b.zoomSpeed=this.ZOOM_SPEED,b.noZoom=!a.zoom,b.noPan=!a.pan,b.autoRotate=a.autoRotate,b.minDistance=a.minDistance,b.maxDistance=a.maxDistance,b.minPolarAngle=a.minPolarAngle,b.maxPolarAngle=a.maxPolarAngle,this.control=b;var c=this;return this.rendererDom.addEventListener("mousedown",function(){c.onMouseDown.call(c)},!1),this.rendererDom.addEventListener("mousewheel",function(){c.onMouseDown.call(c)},!1),Plane.confControl?this.config():this.subscribe("confLoaded",this,this.config),this.control},Controls.prototype.config=function(){var a=Plane.confControl;if(!Hps.isObjEmpty(a)){var b=this.control;void 0!==a.zoom&&(b.noZoom=!a.zoom),void 0!==a.pan&&(b.noPan=!a.pan),void 0!==a.autoRotate&&(b.autoRotate=a.autoRotate),void 0!==a.minDistance&&a.zoom&&(b.minDistance=a.minDistance),void 0!==a.maxDistance&&a.zoom&&(b.maxDistance=a.maxDistance),void 0!==a.minPolarAngle&&(b.minPolarAngle=a.minPolarAngle),void 0!==a.maxPolarAngle&&(b.maxPolarAngle=a.maxPolarAngle)}},Controls.prototype.onMouseDown=function(){Plane.modelViewer.camera=Plane.modelViewer.userCamera,this.control.autoRotate&&this.delayRotate(),Plane.modelViewer.feature.reTimeout()},Controls.prototype.delayRotate=function(){this.control.autoRotate=!1,this.iiiii&&clearTimeout(this.iiiii);var a=this;this.iiiii=setTimeout(function(){a.control.autoRotate=!0},6e4)},Lighting=function(){Sim.Object.call(this),this.enable=!0},Lighting.prototype=new Sim.Object,Lighting.prototype.init=function(){var a=[{type:"PointLight",name:"主光",color:"#ffffff",intensity:1,distance:0,position:[100,10,100]},{type:"PointLight",name:"辅光",color:"#ffffff",intensity:1,distance:0,position:[-100,10,-100]},{type:"AmbientLight",name:"环境光",color:"#ffffff"},{type:"DirectionalLight",name:"打光",color:"#ffffff",intensity:1,position:[10,100,10]}],b=new THREE.Object3D;return b.name="defaultLights",this.createLights(a,b),Plane.lights=b.children,this.setObject3D(b),Plane.confLight?this.config():this.subscribe("confLoaded",this,this.config),this},Lighting.prototype.config=function(){if(0!==Plane.confLight.length){var a=Plane.confLight,b=this.object3D;b.name="confLights";for(var c=b.children.length;c>0;c--)b.remove(b.children[c-1]);this.createLights(a,b)}},Lighting.prototype.createLights=function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=Hps.style2hex(d.color);if("AmbientLight"===d.type){var f=new THREE[d.type](e);f.name=d.name}if("DirectionalLight"===d.type){var f=new THREE[d.type](e,d.intensity);f.name=d.name,f.position.fromArray(d.position)}if("PointLight"===d.type){var f=new THREE[d.type](e,d.intensity,d.distance);f.name=d.name,f.position.fromArray(d.position)}b.add(f)}},SkyBox=function(a){Sim.Object.call(this),this.containner=a,this.enableOne=null},SkyBox.prototype=new Sim.Object,SkyBox.prototype.init=function(a,b){if(void 0!==a&&""!==a){var b=b||1e4,c="/data/models/"+Plane.modelId+"/env/"+a,d=[c+"_px.jpg",c+"_nx.jpg",c+"_py.jpg",c+"_ny.jpg",c+"_pz.jpg",c+"_nz.jpg"],e=THREE.ImageUtils.loadTextureCube(d),f=THREE.ShaderLib.cube;f.uniforms.tCube.value=e;var g=new THREE.ShaderMaterial({fragmentShader:f.fragmentShader,vertexShader:f.vertexShader,uniforms:f.uniforms,side:THREE.BackSide}),h=new THREE.Mesh(new THREE.CubeGeometry(b,b,b),g);return h.name="skybox",this.remove(),this.containner.add(h),this.enableOne=h,this}},SkyBox.prototype.resize=function(a){this.enableOne&&(this.enableOne.geometry.width=a,this.enableOne.geometry.height=a,this.enableOne.geometry.depth=a,this.enableOne.geometry.buffersNeedUpdate=!0)},SkyBox.prototype.remove=function(){null!==this.enableOne&&(this.containner.remove(this.enableOne),this.enableOne=null)},SkyBox.prototype.enable=function(){if(null!==this.enableOne)this.enableOne.visible=!0;else if("skybox"===Plane.confEnvironment.type&&null!=Plane.confEnvironment.skybox)return void this.init(Plane.confEnvironment.skybox)},SkyBox.prototype.disable=function(){null!==this.enableOne&&(this.enableOne.visible=!1)},Animation=function(){Sim.Object.call(this)},Animation.prototype=new Sim.Object,Animation.prototype.init=function(){for(var a,b,c,d=THREE.AnimationHandler,e=0;b>e;++e){var f=a[e];d.add(f);var g=new THREE.KeyFrameAnimation(f.node,f.name);g.timeScale=1,c.push(g)}},Animation.prototype.toggle=function(){},UpdateStatus=function(){this.cbTimer=null,this.el=$("title"),this.title=this.el.html()},UpdateStatus.prototype.confUpdateStart=function(){this.clearCbTimer(),this.el.html("正在提交更改...")},UpdateStatus.prototype.confUpdateSucess=function(){this.clearCbTimer(),this.el.html("已经保存..."),this.setClear()},UpdateStatus.prototype.confUpdateError=function(){this.clearCbTimer(),this.el.html("配置提交出错了！稍后将重试...")},UpdateStatus.prototype.setClear=function(a){var b=this;this.cbTimer=setTimeout(function(){b.clear.call(b)},a||2e3)},UpdateStatus.prototype.clear=function(){this.el.html(this.title)},UpdateStatus.prototype.clearCbTimer=function(){null!==this.cbTimer&&(clearTimeout(this.cbTimer),this.cbTimer=null)},Config=function(){this.conf=null,this.configed=!1,this.changed=!1,this.cache=[[],[],[]]},Config.prototype=new Sim.Publisher,Config.prototype.init=function(){var a=this,b=new XMLHttpRequest;return b.onreadystatechange=function(){4==b.readyState&&((200==b.status||0==b.status)&&(a.conf=0!==b.responseText.length?JSON.parse(b.responseText):null,a.config()),404==b.status&&(a.conf=null,a.config()))},b.open("GET","/api/models/"+Plane.modelId+"/conf",!0),b.setRequestHeader("Content-Type","application/json;charset=utf8"),b.send(null),Plane.config=this,this.conf22={scene:{},material:[{},{DbgName:"name",shading:"lambert",colorDiffuse:[.3,.3,.9],transparency:0,colorAmbient:[.1,.1,.1],reflectivity:.5,specularCoef:30,visible:!0,mapDiffuse:null,mapBump:null,mapNormal:null,mapSpecular:null,mapEnv:!0},{},{},{},{},{},{},{transparency:.8,reflectivity:1,mapEnv:!0},{},{transparency:0}],light:this.defaultLight(),camera:{name:"oneCamera",position:[1,1,10]},control:this.defaultControl()},this},Config.prototype.config=function(){this.conf?(Plane.confMaterial=this.conf.material||[],Plane.confLight=this.conf.light||this.defaultLight(),Plane.confCamera=this.conf.camera||this.defaultCamera(),Plane.confControl=this.conf.control||this.defaultControl(),Plane.confFeature=this.conf.feature||this.testFeature(),Plane.confBackground=this.conf.background||this.defaultBackground(),Plane.confEnvironment=this.conf.environment||this.defaultEnvironment()):(this.conf={},Plane.confMaterial=[],Plane.confLight=this.defaultLight(),Plane.confCamera=this.defaultCamera(),Plane.confControl=this.defaultControl(),Plane.confFeature=this.testFeature(),Plane.confBackground=this.defaultBackground(),Plane.confEnvironment=this.defaultEnvironment()),this.conf.material=Plane.confMaterial,this.conf.light=Plane.confLight,this.conf.camera=Plane.confCamera,this.conf.control=Plane.confControl,this.conf.feature=Plane.confFeature,this.conf.background=Plane.confBackground,this.conf.environment=Plane.confEnvironment,Plane.conf=this.conf,this.publish("confLoaded"),this.configed=!0,this.publish("configed")},Config.prototype.defaultLight=function(){return[{type:"PointLight",name:"主光(点光)",color:"#ffffff",intensity:1,distance:0,position:[100,10,100]},{type:"PointLight",name:"辅光(点光)",color:"#ffffff",intensity:1,distance:0,position:[-100,10,-100]},{type:"AmbientLight",name:"环境光",color:"#ffffff"},{type:"DirectionalLight",name:"打光(平行光)",color:"#ffffff",intensity:1,position:[10,100,10]}]},Config.prototype.defaultCamera=function(){return{front:1,back:1e3,fog:1,position:[0,0,100],up:[0,1,0],lookAt:[0,0,0]}},Config.prototype.defaultControl=function(){return{type:"OrbitControls",zoom:!0,pan:!0,autoRotate:!0,maxDistance:1e5,minDistance:1,minPolarAngle:0,maxPolarAngle:Math.PI}},Config.prototype.testFeature=function(){return[{title:"Feature one",des:"Describe feature one here...",focus:{position:[[-5.02,11.21,99.24],[-5.02,11.21,30.24]],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]],periodTime:2e3}},{title:"Feature two",des:"Describe feature two here...",focus:{position:[[-1.35,2.89,23.56],[-10.35,3.89,20.56]],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]]}},{title:"Feature three",des:"Describe feature three here...",focus:{position:[[32,32,50],[40,55,21]],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]],periodTime:700}}]},Config.prototype.defaultBackground=function(){return{type:"color",color:"#eeeeee",image:"/data/models/blackberry/background/bg.jpg"}},Config.prototype.defaultEnvironment=function(){return{enable:!1,type:"skybox",skybox:"",size:1e5}},Config.prototype.edit=function(a,b,c){if(void 0!==c?c:!0)this.set(a,b),this.autoSave();else{var d=this.cache[0].indexOf(b);-1===d?(this.cache[0].push(b),this.cache[1].push(a)):this.cache[1][d]=a}},Config.prototype.set=function(a,b){if(void 0!=a){void 0===b&&(b=this.conf);for(var c in a){var d=a[c],e=b[c];void 0!==d&&(d instanceof Object?void 0!==e?!(d instanceof Array)||e instanceof Array?!(d instanceof Array)&&d instanceof Object&&e instanceof Array?(b[c]={},this.set(d,b[c])):this.set(d,b[c]):(b[c]=[],this.set(d,b[c])):(b[c]=d instanceof Array?[]:{},this.set(d,b[c])):(b[c]=d,this.changed=!0))}}},Config.prototype.autoSave=function(a){this.autoSaving&&clearTimeout(this.autoSaving);var b=this;this.autoSaving=setTimeout(function(){b.updateToServer.call(b)},a||5e3)},Config.prototype.updateToServer=function(){if(this.changed){void 0===this.updateStatus&&(this.updateStatus=new UpdateStatus),this.updateStatus.confUpdateStart();var a=this;$.ajax({url:"/api/models/"+Plane.modelId+"/conf",type:"POST",data:JSON.stringify(this.conf),contentType:"application/json",processData:!1,statusCode:{200:function(){a.changed=!1},400:function(){}},success:function(){a.updateStatus.confUpdateSucess()},error:function(){return a.updateStatus.confUpdateError(),void 0===a.reUpdateTimerInterval&&(a.reUpdateTimerInterval=2e3),a.reUpdateTimerInterval>8e3?(alert("遇到问题，所做的修改无法提交..."),void(a.reUpdateTimerInterval=void 0)):void a.autoSave.call(a,a.reUpdateTimerInterval+=1e3)}})}},Config.prototype.emptyFeature=function(){var a=Plane.modelViewer.userCamera.position.toArray(),b=[a[0]+5,a[1]+5,a[2]+10];return{title:"Feature newone",des:"Describe this new feature here...",focus:{position:[a,b],lookAt:[[0,0,0],[0,0,0]],up:[[0,1,0],[0,1,0]],periodTime:2e3}}},Config.prototype.setChanged=function(){this.changed=!0,this.autoSave()},FeatureViewer=function(a,b){this.enable=!0,this.showIndex=0,this.defFrequency=3e3,this.userCamera=b,this.featurePanel=$("#featureLeaver"),this.featureMaodian=$("#featureLeaver .features"),this.template=new EJS({url:"/template/temp_featureView.ejs"}),this.timer=null,this.camera=new THREE.PerspectiveCamera(45,a.offsetWidth/a.offsetHeight,.1,1e5),this.camera.name="FeatureCamera",Plane.confFeature?this.config():this.subscribe("confLoaded",this,this.config)},FeatureViewer.prototype=new Sim.Publisher,FeatureViewer.prototype.ready=function(){var a=this,b=Backbone.Router.extend({routes:{"feature/:id":"focusFeatureOf"},focusFeatureOf:function(b){a.focusThe(b)}});this.router=new b,Backbone.history.start()},FeatureViewer.prototype.focusThe=function(a){var b=Plane.modelViewer.camera;this.camera!==b&&(this.camera.position.copy(b.position),Plane.modelViewer.camera=this.camera),this.playing||this.featurePanel.addClass("display");var c=this.features[a].focus;this.camera.position.fromArray(c.position[0]),new TWEEN.Tween(this.camera.position).to({x:c.position[1][0],y:c.position[1][1],z:c.position[1][2]},c.periodTime||1e3).easing(TWEEN.Easing.Sinusoidal.Out).start(),this.featureMaodian.html(this.template.render(this.features[a])),this.showIndex=a},FeatureViewer.prototype.play=function(){if(!this.playing){this.router.navigate("feature/"+this.showIndex,!0);var a=this;this.timer=setInterval(function(){a.next.call(a)},this.defFrequency),this.playing=!0}},FeatureViewer.prototype.stop=function(){this.playing&&clearInterval(this.timer),this.playing=!1},FeatureViewer.prototype.pre=function(){this.showIndex=(this.showIndex+this.features.length-1)%this.features.length,this.router.navigate("feature/"+this.showIndex,!0)},FeatureViewer.prototype.next=function(){this.showIndex=(this.showIndex+1)%this.features.length,this.router.navigate("feature/"+this.showIndex,!0)},FeatureViewer.prototype.reTimeout=function(){if(this.playing){clearInterval(this.timer);var a=this;this.timer=setInterval(function(){a.next.call(a)},2*this.defFrequency)}},FeatureViewer.prototype.toggle=function(){this.playing?(this.stop(),this.featurePanel.removeClass("display")):(this.play(),this.featurePanel.addClass("display"))},FeatureViewer.prototype.exit=function(){this.stop(),this.router.navigate("",!0)},FeatureViewer.prototype.config=function(){0!==Plane.confFeature.length&&(this.features=Plane.confFeature,this.ready())},Audio=function(){this.audio=null,this.playing=!1},Audio.prototype.init=function(){return this.audio=document.createElement("audio"),this.audio.src="/data/models/"+Plane.modelId+"/audio/audio.mp3",this.audio.play(),this.playing=!0,this},Audio.prototype.play=function(){this.playing||(this.audio.play(),this.playing=!0)},Audio.prototype.stop=function(){this.playing&&(this.audio.pause(),this.playing=!1)},Audio.prototype.toggle=function(){},Plane={modelId:getRequest(),model:{id:getRequest(),name:"",des:"",created:null,metadata:null,metaMaterial:null},geometry:null,materials:null,lights:[],conf:null,confMaterial:null,confLight:null,confCamera:null,confControl:null,confBackground:null,confEnvironment:null,parsedData:null,editer:null,renderStatus:{fps:null,ms:null},config:null},ModelViewer=function(){Sim.App.call(this),this.version=1,this.camera=null,this.control=null,this.environment=null,this.bgAudio=null,this.environmentGroup=new THREE.Object3D,this.SkyBox=new SkyBox(this.environmentGroup)},ModelViewer.prototype=new Sim.App,ModelViewer.prototype.init=function(a){Sim.App.prototype.init.call(this,a),this.subscribe("loaded",this,this.initLoaded),this.environmentGroup.name="environment",this.root.add(this.environmentGroup),this.config=(new Config).init();var b=(new MainCamera).init(a.container);this.addObject(b),this.userCamera=b.object3D,this.camera=b.object3D;var c=new Controls(this.camera,this.renderer.domElement);this.control=c.init();var d=(new Lighting).init();this.addObject(d);var e=new JSONModel;e.init(),this.addObject(e),this.feature=new FeatureViewer(a.container,this.camera),this.featureCamera=this.feature.camera,this.stats=new Stats,this.initOptions(),Plane.conf?this.toConfig():this.subscribe("confLoaded",this,this.toConfig)},ModelViewer.prototype.update=function(){TWEEN.update(),this.control&&this.control.update(),this.stats.update(),Sim.App.prototype.update.call(this)},ModelViewer.prototype.initLoaded=function(){},ModelViewer.prototype.toConfig=function(){var a=Plane.confEnvironment;
a&&a.enable&&"skybox"===a.type&&this.SkyBox.init(a.skybox,a.size);var b=Plane.confBackground;b&&($("#WebGLContainer").css({background:b.color}),"image"===b.type&&""!==b.image&&$("#WebGLContainer canvas").css({"background-image":"url("+b.image+")"}))},ModelViewer.prototype.initOptions=function(){var a=function(a){return-1!==a.indexOf("admin")?"admin":-1!==a.indexOf("scene")?"scene":-1!==a.indexOf("iframe")?"iframe":void 0}(document.URL),b=new EJS({url:"/template/temp_sceneOption.ejs"}).render({id:Plane.modelId,type:a});$("#sceneOptionInsert").html(b),$('#canvasOpts a[data-toggle="tooltip"]').tooltip(),$("#saveSnapshot").click(CBS.saveSnapshot()),$("#featurePlay").click(CBS.featurePlay),$("#featureLeaver>a.pre").click(CBS.featurePre),$("#featureLeaver>a.next").click(CBS.featureNext),$("#toggleFullscreen").click(CBS.toggleFullscreen),function(){function a(){b.html(Plane.renderStatus.fps)}var b=$("#renderStatus");void 0!==b[0]&&setInterval(a,1e3)}()},CBS={loadStart:function(){$("#canvasCover").addClass("display")},loadProcess:function(a){$("div#loadingBar div.loadedWidth").css("width",(a.loaded/a.total*100).toFixed(0)+"%")},loadLoaded:function(){$("#canvasCover").removeClass("display")},setMetas:function(a){if(a.err&&alert("ERROR: "+a),Plane.model.id=a.id,Plane.model.name=a.name,Plane.model.des=a.des,Plane.model.created=new Date(a.created),$("#outerName").html(a.name),$("#outerDes").html(a.des),$("#headlineArea>h1").html(a.name),$("#headlineArea>h3").html(a.des),$("head title").html(a.name+" | Not video, is 3D"),void 0!==$("#shareLinks")[0]){var b=new EJS({url:"/template/temp_shareLinks.ejs"}).render({id:a.id});$("#shareLinks").append(b)}},saveSnapshot:function(){var a=0;return function(){var b=$("#WebGLContainer>canvas")[0],c=b.toDataURL();this.href=c,this.download="snapShot"+(0===a?"":a)+".png",a++}},featurePlay:function(){Plane.modelViewer.feature.toggle()},featurePre:function(){var a=Plane.modelViewer.feature;a.playing&&a.reTimeout(),a.pre()},featureNext:function(){var a=Plane.modelViewer.feature;a.playing&&a.reTimeout(),a.next()},toggleFullscreen:function(){$("#WebGLContainer").toggleClass("fullScreen"),$("#header").toggleClass("hiddenStyle");var a=document.getElementById("WebGLContainer");Plane.modelViewer.renderer.setSize(a.offsetWidth,a.offsetHeight),Plane.modelViewer.camera.aspect=a.offsetWidth/a.offsetHeight,Plane.modelViewer.camera.updateProjectionMatrix(),console.log("CSS Resize Render : "+a.offsetWidth+"/"+a.offsetHeight),CBS.toggleScreen()},fullscreen:function(){var a=document.documentElement;return a.webkitRequestFullScreen?a.webkitRequestFullScreen:a.mozRequestFullScreen?a.mozRequestFullScreen:a.requestFullScreen?a.requestFullscreen:function(){}}(),exitFullscreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozExitFullScreen?document.mozExitFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()},toggleScreen:function(){var a=!0;return function(){a?(CBS.exitFullscreen(),a=!1):(CBS.fullscreen.call(document.documentElement),a=!0)}}()},Hps={array2style:function(a){var b=255*a[0]<<16^255*a[1]<<8^255*a[2]<<0;return"#"+("000000"+b.toString(16)).slice(-6)},style2array:function(a){var b=Math.floor(parseInt(a.slice(1),16)),c=(b>>16&255)/255,d=(b>>8&255)/255,e=(255&b)/255;return[c,d,e]},array2hex:function(a){return 255*a[0]<<16^255*a[1]<<8^255*a[2]<<0},hex2style:function(a){return"#"+("000000"+a.toString(16)).slice(-6)},style2hex:function(a){return Hps.array2hex(Hps.style2array(a))},isObjEmpty:function(a){if(null==a)return!1;for(var b in a)return!1;return!0},mtype:function(a){return a instanceof THREE.MeshBasicMaterial?"basic":a instanceof THREE.MeshLambertMaterial?"lambert":a instanceof THREE.MeshPhongMaterial?"phong":a instanceof THREE.ShaderMaterial?"shader":"material"},ltype:function(a){return a instanceof THREE.AmbientLight?"AmbientLight":a instanceof THREE.PointLight?"PointLight":a instanceof THREE.DirectionalLight?"DirectionalLight":"light"},ctype:function(a){return a instanceof THREE.TrackballControls?"TrackballControls":a instanceof THREE.OrbitControls?"OrbitControls":"controls"},btype:function(a){return 0===a?"NoBlending":1===a?"NormalBlending":2===a?"AdditiveBlending":3===a?"SubtractiveBlending":4===a?"MultiplyBlending":"CustomBlending"}};var directiveDemo=angular.module("texture",[]).factory("Texture",["$http",function(a){var b={};return b.textures=[],b.envTextures=[],a.get("/api/models/"+Plane.modelId+"/textures").success(function(a){for(var c=0,d=a.length;d>c;c++)b.textures.push(a[c])}),a.get("/api/models/"+Plane.modelId+"/envTextures").success(function(a){for(var c=0,d=a.length;d>c;c++)b.envTextures.push(a[c])}),b.addTexture=function(a){for(var b=0,c=this.textures.length;c>b;b++)if(a.texture===this.textures[b].texture)return;this.textures.push(a)},b.addEnvTexture=function(a){this.envTextures.push(a)},b.getTextures=function(){return this.textures},b.getEnvTextures=function(){return this.envTextures},b}]),parse=angular.module("parse",["texture"]).factory("Parse",["Texture",function(a){function b(b,c){function d(a){return null==a?[1,1]:a.repeat.toArray()}function e(a){if(null==a)return["clamp","clamp"];var b=a.wrapS===THREE.ClampToEdgeWrapping?"clamp":a.wrapS===THREE.RepeatWrapping?"repeat":"mirror",c=a.wrapT===THREE.ClampToEdgeWrapping?"clamp":a.wrapT===THREE.RepeatWrapping?"repeat":"mirror";return[b,c]}function f(a){if(null==a)return["LinearFilter","LinearMipMapLinearFilter"];var b=a.magFilter===THREE.NearestFilter?"NearestFilter":a.magFilter===THREE.NearestMipMapNearestFilter?"NearestMipMapNearestFilter":a.magFilter===THREE.NearestMipMapLinearFilter?"NearestMipMapLinearFilter":a.magFilter===THREE.LinearFilter?"LinearFilter":a.magFilter===THREE.LinearMipMapNearestFilter?"LinearMipMapNearestFilter":"LinearMipMapLinearFilter",c=a.minFilter===THREE.NearestFilter?"NearestFilter":a.minFilter===THREE.NearestMipMapNearestFilter?"NearestMipMapNearestFilter":a.minFilter===THREE.NearestMipMapLinearFilter?"NearestMipMapLinearFilter":a.minFilter===THREE.LinearFilter?"LinearFilter":a.minFilter===THREE.LinearMipMapNearestFilter?"LinearMipMapNearestFilter":"LinearMipMapLinearFilter";return[b,c]}function g(a){var b=Plane.modelId,c=a.indexOf(b);return c=-1===c?0:c+b.length+1,a.substring(c)}var h={};return h.index=c,h.name=void 0!==b.name&&""!=b.name?b.name:"材质 "+i,h.group=void 0!==b.group?b.group:"",h.visible=b.visible,h.shading=Hps.mtype(b),h.blending=Hps.btype(b.blending),h.wireframe=b.wireframe,h.side=0===b.side?"FrontSide":1===b.side?"BackSide":"DoubleSide",h.color="#"+b.color.getHexString(),"basic"!==h.shading&&(h.ambient=void 0!==b.ambient?"#"+b.ambient.getHexString():"#ffffff"),"phong"===h.shading&&(h.specular=void 0!==b.specular?"#"+b.specular.getHexString():"#ffffff"),"basic"!==h.shading&&(h.emissive=void 0!==b.emissive?"#"+b.emissive.getHexString():"#000000"),h.opacity=b.opacity,h.transparent=b.transparent,h.reflectivity=void 0!==b.reflectivity?b.reflectivity:1,h.refractionRatio=void 0!==b.refractionRatio?b.refractionRatio:1,"phong"===h.shading&&(h.shininess=void 0!==b.shininess?b.shininess:30),h.enableMap=null==b.map?!1:!0,h.map=null===b.map?null:g(b.map.sourceFile),void 0!==b.data&&void 0!==b.data.originalMap&&a.addTexture({name:"map of "+h.name,texture:b.data.originalMap}),h.mapRepeat=d(b.map),h.mapWrap=e(b.map),h.mapFilter=f(b.map),"phong"===h.shading&&(h.enableBump=null==b.bumpMap?!1:!0,h.bumpMap=null==b.bumpMap?null:g(b.bumpMap.sourceFile),void 0!==b.data&&void 0!==b.data.originalBumpMap&&a.addTexture({name:"bumpMap of "+h.name,texture:b.data.originalBumpMap}),h.bumpRepeat=d(b.bumpMap),h.bumpWrap=e(b.bumpMap),h.bumpFilter=f(b.bumpMap)),"phong"===h.shading&&(h.enableNormal=null==b.normalMap?!1:!0,h.normalMap=null==b.normalMap?null:g(b.normalMap.sourceFile),void 0!==b.data&&void 0!==b.data.originalNormalMap&&a.addTexture({name:"normalMap of "+h.name,texture:b.data.originalNormalMap}),h.normalRepeat=d(b.normalMap),h.normalWrap=e(b.normalMap),h.normalFilter=f(b.normalMap)),h.enableLight=null==b.lightMap?!1:!0,h.lightMap=null===b.lightMap?null:g(b.lightMap.sourceFile),void 0!==b.data&&void 0!==b.data.originalLightMap&&a.addTexture({name:"lightMap of "+h.name,texture:b.data.originalLightMap}),h.lightRepeat=d(b.lightMap),h.lightWrap=e(b.lightMap),h.lightFilter=f(b.lightMap),h.enableSpecular=null==b.specularMap?!1:!0,h.specularMap=null===b.specularMap?null:g(b.specularMap.sourceFile),void 0!==b.data&&void 0!==b.data.originalSpecularMap&&a.addTexture({name:"enableSpecular of "+h.name,texture:b.data.originalSpecularMap}),h.specularRepeat=d(b.specularMap),h.specularWrap=e(b.specularMap),h.specularFilter=f(b.specularMap),h.enableEnv=null==b.envMap?!1:!0,h.envMap=null===b.envMap?null:function(a){var b=a.image[0].src;return b.substring(b.lastIndexOf("/")+1,b.lastIndexOf("_"))}(b.envMap),h}function c(a){for(var c=[],d=0,e=a.length;e>d;d++)c.push(b(a[d],d));return c}var d={};return d.data={common:{features:Plane.conf.feature},scene:{camera:Plane.conf.camera,control:Plane.conf.control,lights:Plane.conf.light,background:Plane.conf.background,environment:Plane.conf.environment},materials:c(Plane.materials,d)},d.getCommon=function(){return d.data.common},d.getScene=function(){return d.data.scene},d.getMaterials=function(){return d.data.materials},d.getLights=function(){return d.data.scene.lights},d.checkResource=function(){var a={preview:"",startingPreview:""},b={audio:""};return $.ajax({type:"HEAD",url:"/data/models/"+Plane.modelId+"/preview/preview.png",success:function(){a.preview="/data/models/"+Plane.modelId+"/preview/preview.png"}}),$.ajax({type:"HEAD",url:"/data/models/"+Plane.modelId+"/preview/preview_starting.png",success:function(){a.startingPreview="/data/models/"+Plane.modelId+"/preview/preview_starting.png"}}),function(c){return"previews"===c?a:"audios"===c?b:void 0}}(),d.getCameraPosition=function(){return Plane.modelViewer.userCamera.position.toArray()},d.getCameraQuaternion=function(){return Plane.modelViewer.userCamera.quaternion.toArray()},d.getCameraDistance=function(){var a=Plane.modelViewer.userCamera.position.toArray();return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2))},d.getCameraTarget=function(){return[0,0,0]},d.parsedMaterial=b,d}]),directiveDemo=angular.module("editer.directives",["texture"]).directive("expander",function(){return{priority:1e3,scope:!0,restrict:"EA",templateUrl:"/js/views/expanderTemplate.html",replace:!0,transclude:!0,link:function(a,b,c){a.showMe=!1,$(b).find(".text").html(c.expanderTitle),a.toggle=function(){a.showMe=!a.showMe,a.showMe}}}}).directive("format",function(){return{require:"?ngModel",link:function(a,b,c,d){d&&d.$parsers.push(function(a){return Number(a)})}}}).directive("wSwitch",function(){return{scope:{enable:"=witchEnable"},restrict:"EA",templateUrl:"/js/views/switchTemplate.html",replace:!0,link:function(a){a.toggle=function(){a.enable=!a.enable}}}}).directive("wImgcontrol",["Texture",function(){return{scope:{textures:"=textureLib",choosed:"=handdleWitch",modelId:"@modelId",repeat:"=repeatOne",wrap:"=wrapOne",filter:"=filterOne"},restrict:"EA",templateUrl:"/js/views/imgcontrolTemplate.html",replace:!0,link:function(a){a.showMe=!1,a.createNewone=!1,a.toggle=function(){a.showMe=!a.showMe},a.showThis=function(){a.showMe=!0},a.hiddenThis=function(){a.showMe=!1}}}}]).directive("wEnvcontrol",["Texture",function(){return{scope:{envTextures:"=envLib",choosed:"=handdleWitch",modelId:"@modelId"},restrict:"EA",templateUrl:"/js/views/envcontrolTemplate.html",replace:!0,link:function(a){a.showMe=!1,a.createNewone=!1,a.toggle=function(){a.showMe=!a.showMe},a.showThis=function(){a.showMe=!0},a.hiddenThis=function(){a.showMe=!1}}}}]).directive("wFeatureControl",function(){return{scope:!0,restrict:"EA",templateUrl:"/js/views/featureControlTemplate.html",replace:!0,link:function(){}}}).directive("wTextureUpload",["Texture",function(a){return{scope:{createNewone:"=createNewone",returnTo:"=returnTo",modelId:"@modelId"},restrict:"EA",templateUrl:"/js/views/textureUploadTemplate.html",replace:!0,link:function(b,c){b.uploading=!1,b.enable=!1,b.name="",b.toSelect=function(){b.createNewone=!0},b.exitCreate=function(){b.createNewone=!1},b.updateNewone=function(){var a=$(c).find("input[type=file]")[0].files[0];if(null===b.name||""===b.name)return void alert("为贴图提供命名！");if(void 0==a)return void alert("没有选取文件");var d=new FormData;d.append("name",b.name),d.append("file",a),$.ajax({url:"/api/models/"+b.modelId+"/textures/upload",type:"POST",data:d,processData:!1,contentType:!1,statusCode:{201:function(a){b.handdleSuccess(a)},400:function(){b.uploading=!1}},error:function(){alert("上传出现了问题，请重试！"),b.handdleError()}}),b.uploading=!0},b.handdleSuccess=function(c){b.uploading=!1,a.addTexture(c),b.createNewone=!1,b.$apply(),b.clearInput()},b.handdleError=function(){b.uploading=!1,b.$apply()},b.clearInput=function(){b.name=null,$(c).find("input[type=file]").val("")},b.testResponse=function(){var c={id:"QW23ER4",name:"木头",texture:"texture/wood.jpg"};a.addTexture(c),b.returnTo=c.texture,b.createNewone=!1,b.$apply(),b.clearInput()}}}}]).directive("wEnvTextureUpload",["Texture",function(a){return{scope:{createNewone:"=createNewone",returnTo:"=returnTo",modelId:"@modelId"},restrict:"EA",templateUrl:"/js/views/envTextureUploadTemplate.html",replace:!0,link:function(b,c){b.uploading=!1,b.enable=!1,b.name="",b.toSelect=function(){b.createNewone=!0},b.exitCreate=function(){b.createNewone=!1},b.updateNewone=function(){var a=$(c).find("input.filePx")[0].files[0],d=$(c).find("input.filePy")[0].files[0],e=$(c).find("input.filePz")[0].files[0],f=$(c).find("input.fileNx")[0].files[0],g=$(c).find("input.fileNy")[0].files[0],h=$(c).find("input.fileNz")[0].files[0];if(null===b.name||""===b.name)return void alert("为环境提供命名！");if(void 0==a||void 0==d||void 0==e||void 0==f||void 0==g||void 0==h)return void alert("没有选取文件");var i=new FormData;i.append("name",b.name),i.append("nx",f),i.append("ny",g),i.append("nz",h),i.append("px",a),i.append("py",d),i.append("pz",e),$.ajax({url:"/api/models/"+b.modelId+"/envTextures/upload",type:"POST",data:i,processData:!1,contentType:!1,statusCode:{201:function(a){b.handdleSuccess(a)},400:function(){b.uploading=!1}},error:function(){alert("上传出现了问题，请重试！"),b.handdleError()}}),b.uploading=!0},b.handdleSuccess=function(c){b.uploading=!1,a.addEnvTexture(c),b.returnTo=c.id,b.createNewone=!1,b.$apply(),b.clearInput()},b.handdleError=function(){b.uploading=!1,b.$apply()},b.clearInput=function(){b.name=null,$(c).find("input.filePx").val(""),$(c).find("input.filePy").val(""),$(c).find("input.filePz").val(""),$(c).find("input.fileNx").val(""),$(c).find("input.fileNy").val(""),$(c).find("input.fileNz").val("")},b.testResponse=function(){var c={id:"ccc",name:"CCC",texture:["env/ccc_px.jpg","env/ccc_py.jpg","env/ccc_pz.jpg","env/ccc_nx.jpg","env/ccc_ny.jpg","env/ccc_nz.jpg"]};a.addEnvTexture(c),b.returnTo=c.id,b.createNewone=!1,b.$apply(),b.clearInput()}}}}]).directive("wResourceControl",function(){return{scope:{position:"@rPosition",format:"@rFormat",name:"@rName",modelId:"@modelId",handdle:"=rHanddle"},restrict:"EA",templateUrl:"/js/views/resourceControlTemplate.html",replace:!0,link:function(a,b){a.showMe=!1,a.createNewone=!1,a.uploading=!1,a.enable=!1,a.toggle=function(){a.showMe=!a.showMe},a.toSelect=function(){a.createNewone=!0},a.exitCreate=function(){a.createNewone=!1},a.updateNewone=function(){var c=$(b).find("input[type=file]")[0].files[0];if(void 0==c)return void alert("没有选取文件");if(""!==a.format){var d=c.name.substr(c.name.lastIndexOf(".")+1,a.format.length).toLowerCase();if(d!==a.format)return void alert("必须上传 "+a.format+"格式")}var e=new FormData;e.append("position",a.position),e.append("file",c),e.append("name",a.name),$.ajax({url:"/api/models/"+a.modelId+"/resourceUpload",type:"POST",data:e,processData:!1,contentType:!1,statusCode:{201:function(b,c,d){a.handdle=d.getResponseHeader("Location"),a.handdleSuccess()}},error:function(){alert("上传出现了问题，请重试！"),a.handdleError()}}),a.uploading=!0},a.handdleSuccess=function(){a.uploading=!1,a.createNewone=!1,a.$apply(),a.clearInput()},a.handdleError=function(){a.uploading=!1,a.$apply()},a.clearInput=function(){$(b).find("input[type=file]").val("")}}}}),myEditer=angular.module("editer",["editer.directives","ngRoute","texture","parse"]).config(function(a){a.when("/",{controller:"materialController",templateUrl:"/js/views/materialEditerTemplate.html"}).when("/commonEditer",{controller:"commonController",templateUrl:"/js/views/commonEditerTemplate.html"}).when("/materialEditer",{controller:"materialController",templateUrl:"/js/views/materialEditerTemplate.html"}).when("/sceneEditer",{controller:"sceneController",templateUrl:"/js/views/sceneEditerTemplate.html"})});myEditer.controller("commonController",["$scope","$timeout","Parse",function(a,b,c){function d(){k>5||$.ajax({url:"/models/"+a.modelId+"/update",type:"POST",data:{name:Plane.model.name,des:Plane.model.des},success:function(){0!==k&&(k=0)},error:function(){k++,j&&b.cancel(j),j=b(d,1e3)}})}function e(a,c){a!==c&&""!==a&&(j&&b.cancel(j),j=b(d,3e3))}function f(a,c){a!==c&&""!==a&&(j&&b.cancel(j),j=b(d,3e3))}function g(a,b){a!==b&&""!==a&&Plane.config.setChanged()}function h(a,b){a!==b&&""!==a&&Plane.config.setChanged()}function i(a,b){a!==b&&Plane.config.setChanged()}a.model=Plane.model,a.common=c.getCommon(),a.features=a.common.features,a.previews=c.checkResource("previews"),a.modelId=Plane.modelId,a.feature=a.features[0],a.watchs={},a.watchs.modelName=a.$watch("model.name",e),a.watchs.modelDes=a.$watch("model.des",f),a.watchs.featureTitle=a.$watch("feature.title",g),a.watchs.featureDes=a.$watch("feature.des",h),a.watchs.featureFocusPosition=a.$watch("feature.focus.position",i,!0),a.watchs.featurePeriodTime=a.$watch("feature.focus.periodTime",i),a.cerateNewFeature=function(){a.features.push(Plane.config.emptyFeature()),a.feature=a.common.features[a.common.features.length-1]},a.deleteFeature=function(b){var c=a.common.features.indexOf(b);a.common.features.splice(c,1)},a.getCameraPosition=function(b){var d=c.getCameraPosition(),e=a.feature.focus.position[b];e[0]=d[0],e[1]=d[1],e[2]=d[2]};var j,k=0}]),myEditer.controller("sceneController",["$scope","Texture","Parse",function(a,b,c){function d(){var b=a.lights.indexOf(a.light);a.targetLight=Plane.lights[b]}function e(b,c){b!==c&&(a.targetCamera.near=Number(b),a.targetCamera.updateProjectionMatrix(),console.log(a.targetCamera),Plane.config.setChanged())}function f(b,c){b!==c&&(a.targetCamera.far=Number(b),a.targetCamera.updateProjectionMatrix(),Plane.config.setChanged())}function g(b,c){b!==c&&(new TWEEN.Tween(a.targetCamera.position).to({x:Number(b[0]),y:Number(b[1]),z:Number(b[2])},700).easing(TWEEN.Easing.Sinusoidal.Out).start(),a.targetCamera.updateProjectionMatrix(),Plane.config.setChanged())}function h(b,c){b!==c&&(a.targetControl.noZoom=!b,Plane.config.setChanged())}function i(b,c){b!==c&&(a.targetControl.noPan=!b,Plane.config.setChanged())}function j(b,c){b!==c&&(a.targetControl.autoRotate=b,Plane.config.setChanged())}function k(b,c){if(b!==c){if(b<a.control.minDistance)return a.control.maxDistance=a.control.minDistance,Plane.config.setChanged(),void alert("最远距离 "+b+" 不能小于 最近距离 "+a.control.minDistance+" ！");a.targetControl.maxDistance=b,Plane.config.setChanged()}}function l(b,c){if(b!==c){if(b>a.control.maxDistance)return a.control.minDistance=a.control.maxDistance,Plane.config.setChanged(),void alert("最近距离 "+b+" 不能大于 最远距离 "+a.control.maxDistance+" ！");a.targetControl.minDistance=b,Plane.config.setChanged()}}function m(b,c){b!==c&&(a.targetControl.minPolarAngle=b,Plane.config.setChanged())}function n(b,c){b!==c&&(a.targetControl.maxPolarAngle=b,Plane.config.setChanged())}function o(a,b){a!==b&&Plane.config.setChanged()}function p(b,c){b!==c&&(a.targetLight.name=b,Plane.config.setChanged())}function q(b,c){b!==c&&(a.targetLight.color.setStyle(b),Plane.config.setChanged())}function r(b,c){b!==c&&(a.targetLight.intensity=Number(b),Plane.config.setChanged())}function s(b,c){b!==c&&(a.targetLight.distance=Number(b),Plane.config.setChanged())}function t(b,c){b!==c&&(a.targetLight.position.fromArray(b),Plane.config.setChanged())}function u(b,c){b!==c&&("color"===b&&$("#WebGLContainer canvas").css({"background-image":""}),"image"===b&&$("#WebGLContainer canvas").css({"background-image":"url("+a.background.image+")"}),Plane.config.setChanged())}function v(a,b){a!==b&&($("#WebGLContainer ").css({background:a}),Plane.config.setChanged())}function w(a,b){a!==b&&($("#WebGLContainer canvas").css({"background-image":"url("+a+")"}),Plane.config.setChanged())}function x(b,c){b!==c&&(b?a.targetEnvironment.enable():a.targetEnvironment.disable(),Plane.config.setChanged())}function y(b,c){b!==c&&(a.targetEnvironment.init(b),Plane.config.setChanged())}function z(b,c){b!==c&&(a.targetEnvironment.init(a.environment.skybox,b),Plane.config.setChanged())}a.scene=c.getScene(),a.camera=a.scene.camera,a.control=a.scene.control,a.lights=c.getLights(),a.background=a.scene.background,a.environment=a.scene.environment,a.envTextures=b.getEnvTextures(),a.modelId=Plane.modelId,a.light=a.lights[0],a.targetLight=Plane.lights[0],a.targetCamera=Plane.modelViewer.userCamera,a.targetControl=Plane.modelViewer.control,a.targetEnvironment=Plane.modelViewer.SkyBox,a.watchs={},a.setWatch=function(){},a.getCameraPosition=function(){var b=c.getCameraPosition();a.camera.position[0]=b[0],a.camera.position[1]=b[1],a.camera.position[2]=b[2]},a.getCameraDistance=function(b){0===b&&(a.control.minDistance=c.getCameraDistance()),1===b&&(a.control.maxDistance=c.getCameraDistance())},a.getCameraTarget=function(){a.camera.lookat=c.getCameraTarget()},a.getLightPosition=function(){var b=c.getCameraPosition();a.light.position[0]=b[0],a.light.position[1]=b[1],a.light.position[2]=b[2]},a.watchs.light=a.$watch("light",d),a.watchs.cameraFront=a.$watch("camera.front",e),a.watchs.cameraBack=a.$watch("camera.back",f),a.watchs.cameraPosition=a.$watch("camera.position",g,!0),a.watchs.controlZoom=a.$watch("control.zoom",h),a.watchs.controlPan=a.$watch("control.pan",i),a.watchs.controlAutoRotate=a.$watch("control.autoRotate",j),a.watchs.controlMaxDistance=a.$watch("control.maxDistance",k),a.watchs.controlMinDistance=a.$watch("control.minDistance",l),a.watchs.controlMinPolarAngle=a.$watch("control.minPolarAngle",m),a.watchs.controlMaxPolarAngle=a.$watch("control.maxPolarAngle",n),a.watchs.lightType=a.$watch("light.type",o),a.watchs.lightName=a.$watch("light.name",p),a.watchs.lightColor=a.$watch("light.color",q),a.watchs.lightIntensity=a.$watch("light.intensity",r),a.watchs.lightDistance=a.$watch("light.distance",s),a.watchs.lightPosition=a.$watch("light.position",t,!0),a.watchs.backgroundType=a.$watch("background.type",u),a.watchs.backgroundColor=a.$watch("background.color",v),a.watchs.backgroundImage=a.$watch("background.image",w),a.watchs.environmentEnable=a.$watch("environment.enable",x),a.watchs.environmentSkybox=a.$watch("environment.skybox",y),a.watchs.environmentSize=a.$watch("environment.size",z)}]),myEditer.controller("materialController",["$scope","Texture","Parse",function(a,b,c){function d(){for(key in a.watchs)a.watchs[key]();a.watchs.name=a.$watch("material.name",i),a.watchs.group=a.$watch("material.group",j),a.watchs.visible=a.$watch("material.visible",t),a.watchs.shading=a.$watch("material.shading",V),a.watchs.blending=a.$watch("material.blending",W),a.watchs.side=a.$watch("material.side",X),a.watchs.wireframe=a.$watch("material.wireframe",Y),a.watchs.color=a.$watch("material.color",k),a.watchs.ambient=a.$watch("material.ambient",l),a.watchs.specular=a.$watch("material.specular",m),a.watchs.emissive=a.$watch("material.emissive",n),a.watchs.transparent=a.$watch("material.transparent",o),a.watchs.opacity=a.$watch("material.opacity",p),a.watchs.reflectivity=a.$watch("material.reflectivity",q),a.watchs.refractionRatio=a.$watch("material.refractionRatio",r),a.watchs.shininess=a.$watch("material.shininess",s),a.watchs.map=a.$watch("material.map",u),a.watchs.specularMap=a.$watch("material.specularMap",v),a.watchs.bumpMap=a.$watch("material.bumpMap",w),a.watchs.normalMap=a.$watch("material.normalMap",x),a.watchs.lightMap=a.$watch("material.lightMap",y),a.watchs.envMap=a.$watch("material.envMap",z),a.watchs.enableMap=a.$watch("material.enableMap",A),a.watchs.enableBump=a.$watch("material.enableBump",B),a.watchs.enableNormal=a.$watch("material.enableNormal",C),a.watchs.enableLight=a.$watch("material.enableLight",D),a.watchs.enableSpecular=a.$watch("material.enableSpecular",E),a.watchs.enableEnv=a.$watch("material.enableEnv",F),a.watchs.mapRepeat=a.$watch("material.mapRepeat",G,!0),a.watchs.specularRepeat=a.$watch("material.specularRepeat",H,!0),a.watchs.bumpRepeat=a.$watch("material.bumpRepeat",I,!0),a.watchs.normalRepeat=a.$watch("material.normalRepeat",J,!0),a.watchs.lightRepeat=a.$watch("material.lightRepeat",K,!0),a.watchs.mapWrap=a.$watch("material.mapWrap",L,!0),a.watchs.specularWrap=a.$watch("material.specularWrap",M,!0),a.watchs.bumpWrap=a.$watch("material.bumpWrap",N,!0),a.watchs.normalWrap=a.$watch("material.normalWrap",O,!0),a.watchs.lightWrap=a.$watch("material.lightWrap",P,!0),a.watchs.mapFilter=a.$watch("material.mapFilter",Q,!0),a.watchs.specularFilter=a.$watch("material.specularFilter",R,!0),a.watchs.bumpFilter=a.$watch("material.bumpFilter",S,!0),a.watchs.normalFilter=a.$watch("material.normalFilter",T,!0),a.watchs.lightFilter=a.$watch("material.lightFilter",U,!0)}function e(){for(key in a.watchs)a.watchs[key]()}function f(){d(),a.conf=Plane.conf.material[a.material.index]||{},Plane.conf.material[a.material.index]=a.conf,a.target=Plane.materials[a.material.index]}function g(b,c){var d={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};if("map"===b){if(null===a.material.map)return null;var e=d[c.mapWrap[0]],f=d[c.mapWrap[1]],g=c.mapRepeat,h=THREE.ImageUtils.loadTexture("/data/models/"+a.modelId+"/"+a.material.map);return h.wrapS=e,h.wrapT=f,h.repeat.fromArray(g),h}if("specularMap"===b){if(null===a.material.specularMap)return null;var e=d[c.specularWrap[0]],f=d[c.specularWrap[1]],g=c.specularRepeat,h=THREE.ImageUtils.loadTexture("/data/models/"+a.modelId+"/"+a.material.specularMap);return h.wrapS=e,h.wrapT=f,h.repeat.fromArray(g),h}if("bumpMap"===b){if(null===a.material.bumpMap)return null;var e=d[c.bumpWrap[0]],f=d[c.bumpWrap[1]],g=c.bumpRepeat,h=THREE.ImageUtils.loadTexture("/data/models/"+a.modelId+"/"+a.material.bumpMap);return h.wrapS=e,h.wrapT=f,h.repeat.fromArray(g),h}if("normalMap"===b){if(null===a.material.normalMap)return null;var e=d[c.normalWrap[0]],f=d[c.normalWrap[1]],g=c.normalRepeat,h=THREE.ImageUtils.loadTexture("/data/models/"+a.modelId+"/"+a.material.normalMap);return h.wrapS=e,h.wrapT=f,h.repeat.fromArray(g),h}if("lightMap"===b){if(null===a.material.lightMap)return null;var e=d[c.lightWrap[0]],f=d[c.lightWrap[1]],g=c.lightRepeat,h=THREE.ImageUtils.loadTexture("/data/models/"+a.modelId+"/"+a.material.lightMap);return h.wrapS=e,h.wrapT=f,h.repeat.fromArray(g),h}if("envMap"===b){if(null===a.material.envMap)return null;var i="/data/models/"+a.modelId+"/env/"+a.material.envMap,j=[i+"_px.jpg",i+"_nx.jpg",i+"_py.jpg",i+"_ny.jpg",i+"_pz.jpg",i+"_nz.jpg"];return THREE.ImageUtils.loadTextureCube(j)}}function h(){var a=Plane.geometry;a.uvsNeedUpdate=!0,a.normalsNeedUpdate=!0,a.buffersNeedUpdate=!0}function i(b,c){b!==c&&(a.target.name=b,Plane.config.edit({DbgName:b},a.conf))}function j(b,c){b!==c&&(a.target.group=b,Plane.config.edit({group:b},a.conf))}function k(b,c){b!==c&&(a.target.color.setStyle(b),Plane.config.edit({colorDiffuse:Hps.style2array(b)},a.conf))}function l(b,c){b!==c&&(a.target.ambient.setStyle(b),a.target.needsUpdate=!0,Plane.config.edit({colorAmbient:Hps.style2array(b)},a.conf))}function m(b,c){b!==c&&(a.target.specular.setStyle(b),Plane.config.edit({colorSpecular:Hps.style2array(b)},a.conf))}function n(b,c){b!==c&&(a.target.emissive.setStyle(b),Plane.config.edit({colorEmissive:Hps.style2array(b)},a.conf))}function o(b,c){b!==c&&(a.target.transparent=b,Plane.config.edit({transparent:b},a.conf))}function p(b,c){b!==c&&(a.target.opacity=b,Plane.config.edit({transparency:Number(b)},a.conf))}function q(b,c){b!==c&&(a.target.reflectivity=b,Plane.config.edit({reflectivity:Number(b)},a.conf))}function r(b,c){b!==c&&(a.target.refractionRatio=b,Plane.config.edit({refractionRatio:Number(b)},a.conf))}function s(b,c){b!==c&&(a.target.shininess=b,Plane.config.edit({specularCoef:Number(b)},a.conf))}function t(b,c){b!==c&&(a.target.visible=b,Plane.config.edit({visible:b},a.conf))}function u(b,c){b!==c&&(a.target.map=g("map",a.material),a.target.needsUpdate=!0,h(),Plane.config.edit({mapDiffuse:b},a.conf))}function v(b,c){b!==c&&(a.target.specularMap=g("specularMap",a.material),a.target.needsUpdate=!0,h(),Plane.config.edit({mapSpecular:b},a.conf))}function w(b,c){b!==c&&(a.target.bumpMap=g("bumpMap",a.material),a.target.needsUpdate=!0,h(),Plane.config.edit({mapBump:b},a.conf))}function x(b,c){b!==c&&(a.target.normalMap=g("normalMap",a.material),a.target.needsUpdate=!0,h(),Plane.config.edit({mapNormal:b},a.conf))}function y(b,c){b!==c&&(a.target.lightMap=g("lightMap",a.material),a.target.needsUpdate=!0,h(),Plane.config.edit({mapLight:b},a.conf))}function z(b,c){b!==c&&(a.target.envMap=g("envMap"),a.target.needsUpdate=!0,Plane.config.edit({mapEnv:b},a.conf))}function A(b,c){b!==c&&(a.target.map=b===!1?null:g("map",a.material),a.target.needsUpdate=!0,Plane.config.edit({enableMap:b},a.conf))}function B(b,c){b!==c&&(a.target.bumpMap=b===!1?null:g("bumpMap",a.material),a.target.needsUpdate=!0,Plane.config.edit({enableBump:b},a.conf))}function C(b,c){b!==c&&(a.target.normalMap=b===!1?null:g("normalMap",a.material),a.target.needsUpdate=!0,Plane.config.edit({enableNormal:b},a.conf))}function D(b,c){b!==c&&(a.target.lightMap=b===!1?null:g("lightMap",a.material),a.target.needsUpdate=!0,Plane.config.edit({enableLight:b},a.conf))}function E(b,c){b!==c&&(a.target.specularMap=b===!1?null:g("specularMap",a.material),a.target.needsUpdate=!0,Plane.config.edit({enableSpecular:b},a.conf))}function F(b,c){b!==c&&(a.target.envMap=b===!1?null:g("envMap"),a.target.needsUpdate=!0,Plane.config.edit({enableEnv:b},a.conf))}function G(b,c){b!==c&&(a.target.map.repeat.fromArray(b),a.target.map.needsUpdate=!0,Plane.config.edit({mapDiffuseRepeat:b},a.conf))}function H(b,c){b!==c&&(a.target.specularMap.repeat.fromArray(b),a.target.specularMap.needsUpdate=!0,Plane.config.edit({mapSpecularRepeat:b},a.conf))}function I(b,c){b!==c&&(a.target.bumpMap.repeat.fromArray(b),a.target.bumpMap.needsUpdate=!0,Plane.config.edit({mapBumpRepeat:b},a.conf))}function J(b,c){b!==c&&(a.target.normalMap.repeat.fromArray(b),a.target.normalMap.needsUpdate=!0,Plane.config.edit({mapNormalRepeat:b},a.conf))}function K(b,c){b!==c&&(a.target.lightMap.repeat.fromArray(b),a.target.lightMap.needsUpdate=!0,Plane.config.edit({mapLightRepeat:b},a.conf))}function L(b,c){if(b!==c){var d={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};a.target.map.wrapS=d[b[0]],a.target.map.wrapT=d[b[1]],a.target.map.needsUpdate=!0,Plane.config.edit({mapDiffuseWrap:b},a.conf)}}function M(b,c){if(b!==c){var d={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};a.target.specularMap.wrapS=d[b[0]],a.target.specularMap.wrapT=d[b[1]],a.target.specularMap.needsUpdate=!0,Plane.config.edit({mapSpecularWrap:b},a.conf)}}function N(b,c){if(b!==c){var d={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};a.target.bumpMap.wrapS=d[b[0]],a.target.bumpMap.wrapT=d[b[1]],a.target.bumpMap.needsUpdate=!0,Plane.config.edit({mapBumpWrap:b},a.conf)}}function O(b,c){if(b!==c){var d={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};a.target.normalMap.wrapS=d[b[0]],a.target.normalMap.wrapT=d[b[1]],a.target.normalMap.needsUpdate=!0,Plane.config.edit({mapNormalWrap:b},a.conf)
}}function P(b,c){if(b!==c){var d={clamp:THREE.ClampToEdgeWrapping,repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};a.target.lightMap.wrapS=d[b[0]],a.target.lightMap.wrapT=d[b[1]],a.target.lightMap.needsUpdate=!0,Plane.config.edit({mapLightWrap:b},a.conf)}}function Q(b,c){b!==c&&(a.target.map.magFilter=THREE[b[0]],a.target.map.minFilter=THREE[b[1]],a.target.map.needsUpdate=!0,Plane.config.edit({mapDiffuseFilter:b},a.conf))}function R(b,c){b!==c&&(a.target.specularMap.magFilter=THREE[b[0]],a.target.specularMap.minFilter=THREE[b[1]],a.target.specularMap.needsUpdate=!0,Plane.config.edit({mapSpecularFilter:b},a.conf))}function S(b,c){b!==c&&(a.target.bumpMap.magFilter=THREE[b[0]],a.target.bumpMap.minFilter=THREE[b[1]],a.target.bumpMap.needsUpdate=!0,Plane.config.edit({mapBumpFilter:b},a.conf))}function T(b,c){b!==c&&(a.target.normalMap.magFilter=THREE[b[0]],a.target.normalMap.minFilter=THREE[b[1]],a.target.normalMap.needsUpdate=!0,Plane.config.edit({mapNormalFilter:b},a.conf))}function U(b,c){b!==c&&(a.target.lightMap.magFilter=THREE[b[0]],a.target.lightMap.minFilter=THREE[b[1]],a.target.lightMap.needsUpdate=!0,Plane.config.edit({mapLightFilter:b},a.conf))}function V(b,f){if(b!==f&&b!==Hps.mtype(a.target)){var g=a.material.index,h=Plane.model.metaMaterial[g];h.shading=b,a.conf.shading=b;var i=THREE.Loader.prototype.createMaterial(h,"/data/models/"+Plane.modelId+"/");Plane.materials[g]=i,JSONModel.prototype.editMaterial(a.conf,i),e(),a.materials[g]=c.parsedMaterial(i,g),d(),a.target=i,a.material=a.materials[g],a.target.needsUpdate=!0,Plane.config.setChanged()}}function W(b,c){b!==c&&void 0!==THREE[b]&&(a.target.blending=THREE[b],a.target.needsUpdate=!0,Plane.config.edit({blending:b},a.conf))}function X(b,c){b!==c&&void 0!==THREE[b]&&(a.target.side=THREE[b],a.target.needsUpdate=!0,Plane.config.edit({side:b},a.conf))}function Y(b,c){b!==c&&(a.target.wireframe=b,a.target.needsUpdate=!0,Plane.config.edit({wireframe:b},a.conf))}a.materials=c.getMaterials(),a.textures=b.getTextures(),a.envTextures=b.getEnvTextures(),a.modelId=Plane.modelId,a.material=a.materials[0],a.target=Plane.materials[a.material.index],a.conf=Plane.conf.material[a.material.index]||{},Plane.conf.material[a.material.index]=a.conf,a.watchs={},a.removeCurrentGroup=function(){a.material.group=null},a.$watch("material",f)}]),Editer=function(){},Editer.prototype=new Sim.Publisher,Editer.prototype.init=function(){return this.subscribe("loaded",this,this.onModelLoaded),this.subscribe("configed",this,this.onConfiged),this},Editer.prototype.startAngularRun=function(){angular.bootstrap($("#editer"),["editer"])},Editer.prototype.onModelLoaded=function(){this.loaded=!0,this.todo()},Editer.prototype.onConfiged=function(){this.configed=!0,this.todo()},Editer.prototype.todo=function(){(new Date).getTime()>14069088e5||this.loaded&&this.configed&&this.startAngularRun()},(new Editer).init();